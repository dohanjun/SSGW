<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yedam.app.group.mapper.ApprovalMapper">

	<!-- 결재대기함 -->
	<select id="selectAprvList" resultType="ApprovalVO">
		SELECT d.DRAFT_NO
		       , d.TITLE
		       , d.CONTENT
		       , d.APRV_STATUS
		       , d.REJECT_REASON 
		       , d.DRAFT_DATE
		       , e.EMPLOYEE_NAME
		       , d.APRV_DATE
		       , d.FORM_ID
		       , d.BASICS_FORM_ID
		       , d.SUBER_NO
               , r.employee_no
		FROM aprv_documents d
		JOIN employees e 
			ON d.EMPLOYEE_NO = e.EMPLOYEE_NO
        JOIN aprv_routes r
            ON r.employee_no = e.employee_no
        WHERE d.APRV_STATUS = '대기'
	</select>

	<!-- 결재대기함(검색) -->
	<select id="searchAprvList" resultType="ApprovalVO"
		parameterType="ApprovalVO">
		SELECT d.DRAFT_NO, d.TITLE, d.CONTENT, d.APRV_STATUS, d.REJECT_REASON,
		d.DRAFT_DATE,
		e.EMPLOYEE_NAME, d.APRV_DATE, d.FORM_ID,
		d.BASICS_FORM_ID, d.SUBER_NO
		FROM
		aprv_documents d
		JOIN employees e ON
		d.EMPLOYEE_NO = e.EMPLOYEE_NO
		WHERE 1=1
		<if test="employeeName != null and employeeName != ''">
			AND e.EMPLOYEE_NAME LIKE '%' || #{employeeName} || '%'
		</if>
		<if test="title != null and title != ''">
			AND d.TITLE LIKE '%' || #{title} || '%'
		</if>
		<if test="draftDate != null">
			AND d.DRAFT_DATE = #{draftDate}
		</if>
	</select>

	<!-- 결재 상세 조회 (도장 정보 포함) -->
	<select id="selectAprvInfo" resultType="ApprovalVO"
		parameterType="ApprovalVO">
		SELECT d.DRAFT_NO
		, d.EMPLOYEE_NO
		, d.TITLE
		, d.CONTENT
		, d.APRV_STATUS
		, d.REJECT_REASON
		, d.DRAFT_DATE
		, d.APRV_DATE
		, s.STAMP_IMG_PATH
		FROM aprv_documents d
		LEFT JOIN stamp s
		ON
		d.EMPLOYEE_NO = s.EMPLOYEE_NO
		AND s.ACTIVE = '1'
		WHERE d.DRAFT_NO = #{draftNo}
	</select>

	<!-- 도장 등록 -->
	<insert id="insertStamp" parameterType="ApprovalVO">
	 <selectKey keyProperty="stampId"
				   resultType="Integer"
				   order="BEFORE">
			SELECT NVL(MAX(stamp_id), 1) + 1
			FROM stamp
	 </selectKey>
		INSERT INTO stamp(STAMP_IMG_PATH
						  ,EMPLOYEE_NO
						  ,STAMP_ID
						  ,ACTIVE)
		VALUES			(#{stampImgPath}
						, 1
						, #{stampId}
						,'1')
	</insert>
	
	<!-- 도장수정 -->
	<update id="updateStamp" parameterType="ApprovalVO">
		UPDATE stamp
		SET active = '0'
		WHERE active = '1'
		AND   employee_no = 1
	</update>
	
	
	<!-- 회사 전자결재 양식 등록 -->
	<insert id="insertForm" parameterType="ApprovalFormVO">
		<selectKey keyProperty="formId"
				   resultType="Integer"
				   order="BEFORE">
			SELECT NVL(MAX(form_id), 1) + 1
			FROM aprv_forms
		</selectKey>
		INSERT INTO aprv_forms (form_id
		                        , form_type
		                        , content
		                        , version
		                        , active
		                        , creation_date
		                        , suber_no)
		VALUES(#{formId}
		       ,#{formType}
		       ,#{content}
		       ,1
		       ,'1'
		       ,sysdate
		       ,1)
	</insert>
</mapper>
