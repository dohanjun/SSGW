<!DOCTYPE html>
<div xmlns:th="https://www.thymeleaf.org" th:fragment="header">
	<!-- Topbar -->
	<nav
		class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
		<!-- Sidebar Toggle (Topbar) -->
		<button id="sidebarToggleTop"
			class="btn btn-link d-md-none rounded-circle mr-3">
			<i class="fa fa-bars"></i>
		</button>
		<div style="font-size: 1.2rem; font-weight: bold; margin: 20px 0;">
			<span th:text="${userInfo.employeeName + 'ë‹˜ '}"></span> <span
				id="greeting"></span>
		</div>
		<ul class="navbar-nav ml-auto">
			<!-- Nav Item - Search Dropdown (Visible Only XS) -->
			<li class="nav-item dropdown no-arrow d-sm-none"><a
				class="nav-link dropdown-toggle" href="#" id="searchDropdown"
				role="button" data-toggle="dropdown" aria-haspopup="true"
				aria-expanded="false"> <i class="fas fa-search fa-fw"></i>


			</a> <!-- ì—¬ê¸° -->
				<div
					class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
					aria-labelledby="searchDropdown">
					<form class="form-inline mr-auto w-100 navbar-search">
						<div class="input-group">
							<input type="text" class="form-control bg-light border-0 small"
								placeholder="Search for..." aria-label="Search"
								aria-describedby="basic-addon2">
							<div class="input-group-append">
								<button class="btn btn-primary" type="button">
									<i class="fas fa-search fa-sm"></i>
								</button>
							</div>
						</div>
					</form>
				</div></li>
			<!-- âœ… ì¶œê·¼/í‡´ê·¼ ë²„íŠ¼ ì¶”ê°€ (ì‚¬ìš©ì ì •ë³´ ì „ì— ë°°ì¹˜) -->
			<li class="nav-item mx-2 d-flex align-items-center">
				<button class="btn btn-success mx-1" id="startWorkBtn">ì¶œê·¼</button>
				<button class="btn btn-danger mx-1" id="endWorkBtn">í‡´ê·¼</button>
			</li>
			<!-- Nav Item - Alerts -->
			<li class="nav-item dropdown no-arrow mx-1"><a
				class="nav-link dropdown-toggle" href="#" id="alertsDropdown"
				role="button" data-toggle="dropdown" aria-haspopup="true"
				aria-expanded="false"> <i class="fas fa-bell fa-fw"></i> <!-- Counter - Alerts -->
					<span class="badge badge-danger badge-counter alrambadge"></span>
			</a> <!-- ë°‘ì— ë³´ì—¬ì§€ëŠ” ë¶€ë¶„ -->
				<div
					class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
					aria-labelledby="alertsDropdown">
					<h6 class="dropdown-header">ë¯¸í™•ì¸ ì•ŒëŒ</h6>

					<!-- ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
					<div id="alertListContainer"
						style="max-height: 300px; overflow-y: auto;">
						<!-- ì•Œë¦¼ ë‚´ìš©ì€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
					</div>

				</div></li>

			<!-- Nav Item - Messages -->
			<li class="nav-item dropdown no-arrow mx-1"><a
				class="nav-link dropdown-toggle" href="#" id="messagesDropdown"
				role="button" data-toggle="dropdown" aria-haspopup="true"
				aria-expanded="false"> <i class="fas fa-envelope fa-fw"></i> <!-- Counter - Messages -->
					<span class="badge badge-danger badge-counter">7</span>
			</a> <!-- Dropdown - Messages -->
				<div
					class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
					aria-labelledby="messagesDropdown">
					<h6 class="dropdown-header">Message Center</h6>
					<a class="dropdown-item d-flex align-items-center" href="#">
						<div class="dropdown-list-image mr-3">
							<img class="rounded-circle" src="img/undraw_profile_1.svg"
								alt="...">
							<div class="status-indicator bg-success"></div>
						</div>
						<div class="font-weight-bold">
							<div class="text-truncate">Hi there! I am wondering if you
								can help me with a problem I've been having.</div>
							<div class="small text-gray-500">Emily Fowler Â· 58m</div>
						</div>
					</a> <a class="dropdown-item d-flex align-items-center" href="#">
						<div class="dropdown-list-image mr-3">
							<img class="rounded-circle" src="img/undraw_profile_2.svg"
								alt="...">
							<div class="status-indicator"></div>
						</div>
						<div>
							<div class="text-truncate">I have the photos that you
								ordered last month, how would you like them sent to you?</div>
							<div class="small text-gray-500">Jae Chun Â· 1d</div>
						</div>
					</a> <a class="dropdown-item d-flex align-items-center" href="#">
						<div class="dropdown-list-image mr-3">
							<img class="rounded-circle" src="img/undraw_profile_3.svg"
								alt="...">
							<div class="status-indicator bg-warning"></div>
						</div>
						<div>
							<div class="text-truncate">Last month's report looks great,
								I am very happy with the progress so far, keep up the good work!</div>
							<div class="small text-gray-500">Morgan Alvarez Â· 2d</div>
						</div>
					</a> <a class="dropdown-item d-flex align-items-center" href="#">
						<div class="dropdown-list-image mr-3">
							<img class="rounded-circle"
								src="https://source.unsplash.com/Mv9hjnEUHR4/60x60" alt="...">
							<div class="status-indicator bg-success"></div>
						</div>
						<div>
							<div class="text-truncate">Am I a good boy? The reason I
								ask is because someone told me that people say this to all dogs,
								even if they aren't good...</div>
							<div class="small text-gray-500">Chicken the Dog Â· 2w</div>
						</div>
					</a> <a class="dropdown-item text-center small text-gray-500" href="#">Read
						More Messages</a>
				</div></li>

			<!-- Nav Item - User Information -->
			<li class="nav-item dropdown no-arrow"><a
				class="nav-link dropdown-toggle" id="userDropdown" role="button"
				data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					<span class="mr-2 d-none d-lg-inline text-gray-600 small"></span> <img
					class="img-profile rounded-circle" src="img/undraw_profile.svg">
			</a>
				<div
					class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
					aria-labelledby="userDropdown">
					<a class="dropdown-item" href="MyPageInfo"> <i
						class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> ë§ˆì´í˜ì´ì§€
					</a> <a class="dropdown-item" href="#"> <i
						class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i> Activity
						Log
					</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="logout" data-toggle="modal"
						data-target="#logoutModal"> <i
						class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
						Logout
					</a>
				</div></li>

		</ul>

	</nav>
	<!-- End of Topbar -->

	<script>
	document.addEventListener("DOMContentLoaded", function () {
	    const startBtn = document.getElementById("startWorkBtn");
	    const endBtn = document.getElementById("endWorkBtn");
	    const csrfToken = document.querySelector("[name='_csrf']")?.getAttribute("content") || "";

	    if (startBtn) {
	        startBtn.addEventListener("click", async () => {
	            try {
	                // âœ… 1. ì§€ê° ì—¬ë¶€ í™•ì¸
	                const response = await fetch("/attendance/check-late");
	                const result = await response.json();

	                let reason = "";

	                // âœ… 2. ì§€ê°ì´ë©´ ì‚¬ìœ  ì…ë ¥ ë°›ê¸°
	                if (result.status === "LATE") {
	                    reason = prompt("â° ì§€ê°ì…ë‹ˆë‹¤. ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
	                    if (!reason || reason.trim() === "") {
	                        alert("âŒ ì§€ê° ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ ì¶œê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
	                        return;
	                    }
	                }

	                // âœ… 3. ì¶œê·¼ ìš”ì²­ (ì‚¬ìœ  í¬í•¨)
	                fetch("/attendance/clock-in", {
	                    method: "POST",
	                    headers: {
	                        "Content-Type": "application/json",
	                        "X-CSRF-TOKEN": csrfToken
	                    },
	                    body: JSON.stringify({ reason: reason })
	                })
	                .then(res => res.json())
	                .then(data => alert(data.message))
	                .catch(err => console.error("ì¶œê·¼ ì˜¤ë¥˜:", err));

	            } catch (err) {
	                console.error("ì§€ê° ì²´í¬ ì˜¤ë¥˜:", err);
	            }
	        });
	    }

	    if (endBtn) {
	        endBtn.addEventListener("click", () => {
	            fetch("/attendance/clock-out", {
	                method: "POST",
	                headers: {
	                    "X-CSRF-TOKEN": csrfToken
	                }
	            })
	            .then(res => res.json())
	            .then(data => alert(data.message))
	            .catch(err => console.error("í‡´ê·¼ ì˜¤ë¥˜:", err));
	        });
	    }
	});

</script>
	<script>
  const messages = [
    "ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš” ğŸ’ª",
    "ë©‹ì§€ê²Œ í•˜ë£¨ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”? ğŸŒŸ",
    "ë‹¹ì‹ ì˜ ë…¸ë ¥ì„ ì‘ì›í•©ë‹ˆë‹¤ ğŸ™Œ",
    "ì‘ì€ ì„±ì·¨ë„ í° ê±¸ìŒì´ì—ìš” ğŸ‘£",
    "ì§€ì¹˜ì§€ ë§ˆì„¸ìš”, ê³§ ì¢‹ì€ ì¼ì´ ìƒê¸¸ ê±°ì˜ˆìš” ğŸ˜Š",
    "ì˜¤ëŠ˜ë„ íŒŒì´íŒ…! ğŸ”¥",
    "ìŠ¤ìŠ¤ë¡œë¥¼ ë¯¿ìœ¼ì„¸ìš” ğŸ’–",
    ": ì•„ ì§‘ê°€ê³  ì‹¶ë‹¤ ğŸ ",
    "ì›”ê¸‰ì€ ì•ˆì˜¤ë¥´ê³  ë¬¼ê°€ëŠ” ì˜¤ë¥´ê³  ì—íœ´! ğŸ’¸",
    "ì´ê²Œ ë§ë‚˜ ì‹¶ì§€ë§Œ ì¼ë‹¨ í•´ë´…ì‹œë‹¤ ğŸ˜¶â€",
    "ì–¸ì  ê°€ëŠ” ë¹›ë‚  ë‚ ì´ ì˜¬ ê±°ì˜ˆìš” âœ¨",
    "ì»¤í”¼ í•œ ì”ìœ¼ë¡œ ë²„í…¨ë´…ì‹œë‹¤ â˜•",
    "ì˜¤ëŠ˜ë„ ì¶œê·¼í•˜ì‹  ê±°, ì •ë§ ëŒ€ë‹¨í•´ìš” ğŸ‘",
    "ì ì‹¬ì‹œê°„ë§Œ ê¸°ë‹¤ë ¤ì ¸ìš” ğŸ±",
    "í‡´ê·¼ì´ ê¸°ë‹¤ë ¤ì§€ë„¤ìš” ğŸƒâ€â™‚ï¸",
    "ë‚´ì¼ì€ ë” ë‚˜ì„ ê±°ì˜ˆìš” ğŸ™",
    "ì§€ê¸ˆ ì˜í•˜ê³  ê³„ì‹­ë‹ˆë‹¤ ğŸ˜Š",
    "ì´ ë˜í•œ ì§€ë‚˜ê°ˆ ê±°ì˜ˆìš” ğŸƒ",
    "ë‹¤ë“¤ í˜ë“  ì‹œê¸°ì§€ë§Œ, í•¨ê»˜ ì´ê²¨ëƒ…ì‹œë‹¤ ğŸ’ª",
    "í•˜ë£¨í•˜ë£¨ê°€ ìŒ“ì—¬ì„œ ë‚´ì¼ì„ ë§Œë“­ë‹ˆë‹¤ ğŸ§±"
    
  ];

  // ëœë¤ìœ¼ë¡œ ë©”ì‹œì§€ í•˜ë‚˜ ì„ íƒ
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];

  // í™”ë©´ì— ì¶œë ¥
  document.getElementById("greeting").innerText = randomMessage;
</script>
	<script src="/js/common.js"></script>
	<script th:inline="javascript">
const employeeNo = /*[[${userInfo.employeeNo}]]*/[];

//ì•Œë¦¼ í´ë¦­ ì‹œ ì½ìŒ ì²˜ë¦¬
function markAsRead(alertNo) {
    fetch(`/alerts/markAsRead?alertNo=${alertNo}`, {
        method: 'POST',  // POST ë°©ì‹ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())  // ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±
    .then(data => {

        loadMoreAlerts(); // ì½ìŒ ì²˜ë¦¬ í›„ ì•Œë¦¼ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œ
    })
    .catch(error => {
        console.error("ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
    });
}


// ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
function loadMoreAlerts() {
	fetch(`/alerts?employeeNo=${employeeNo}`)
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById("alertListContainer");
        const showMore = document.getElementById("alertShowMore");
        const badge = document.querySelector('.alrambadge');
        container.innerHTML = "";
        
        if (data.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-3">
                    ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>`;
            badge.textContent = "";
            return;
        }
	    
        data.forEach(alert => {
            const alertDate = new Date(alert.createDate);
            const formattedDate = ("0" + alertDate.getFullYear()).slice(-2) + "/" + 
                                  ("0" + (alertDate.getMonth() + 1)).slice(-2) + "/" + 
                                  ("0" + alertDate.getDate()).slice(-2);

            const alertHTML = `
                <a class="dropdown-item d-flex align-items-center" href="#" onclick="markAsRead(${alert.alarmNo})">
                    <div class="mr-3">
                        <div class="icon-circle bg-${alert.alarmType}">
                            <i class="fas ${alert.alarmIcon} text-white"></i>
                        </div>
                    </div>
                    <div>
                        <div class="small text-gray-500">${formattedDate}</div>
                        <span class="font-weight-bold">${alert.alarmMessage}</span>
                    </div>
                </a>`;
            container.insertAdjacentHTML("beforeend", alertHTML);
        });
        const totalAlerts = data.length;
        const badgeText = totalAlerts > 9 ? "9+" : totalAlerts;
        badge.textContent = badgeText;
    })
    .catch(error => {
        console.error("ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
    });
}
loadMoreAlerts(); // í˜ì´ì§€ ë¡œë”© ì‹œ ì²« ë²ˆì§¸ ì•Œë¦¼ì„ ë¡œë“œ
</script>

</div>