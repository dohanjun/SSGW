<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>기안문 작성</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/approval.css}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
</head>
<body>

<div class="container mt-5">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">기안문 작성</h6>
            <div>
                <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#formModal">
                    양식 선택 <span class="material-symbols-outlined">search</span>
                </button>
                <button type="button" class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#approverModal">
                    결재선등록 <span class="material-symbols-outlined">search</span>
                </button>
                <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#referenceModal">
                    참조자등록 <span class="material-symbols-outlined">search</span>
                </button>
            </div>
        </div>
        <div class="card-body">
            <form action="/aprv/writing" method="POST">
                <input type="hidden" name="formId" id="formIdInput">
                <input type="hidden" name="basicsFormId" id="basicsFormIdInput">
                <input type="hidden" name="content" id="contentHidden">
                <input type="hidden" name="status" id="statusInput">
                <div class="form-group">
                    <label>제목</label>
                    <input type="text" class="form-control" name="title">
                </div>
                <div class="form-group">
                    <label>내용</label>
                    <div id="Content" class="p-3 border rounded" style="min-height: 200px; background-color: #f8f9fc;"></div>
                    <textarea name="content" id="contentHidden" hidden></textarea>
                </div>
                <div class="form-group">
                    <label>결재자</label>
                    <ul id="selectedApproverList" class="list-group mb-2"></ul>
                    <input type="hidden" name="approvers" id="approversInput">
                </div>
                <div class="form-group">
                    <label>참조자</label>
                    <ul id="selectedReferenceList" class="list-group mb-2"></ul>
                    <input type="hidden" name="references" id="referencesInput">
                </div>

                <div class="text-right">
                    <button type="submit" class="btn btn-primary">등록</button>
                    <button type="button" class="btn btn-primary" id="tempSaveButton">임시저장</button>
                    <button type="reset" class="btn btn-secondary">초기화</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 양식 선택 모달 -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>양식 선택</h5></div>
            <div class="modal-body">
                <h6>기본 양식</h6>
                <ul id="basicsFormsList"></ul>
                <hr>
                <h6>회사 전용 양식</h6>
                <ul id="aprvFormsList"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">닫기</button>
                <button class="btn btn-primary" id="loadFormBtn">불러오기</button>
            </div>
        </div>
    </div>
</div>

<!-- 결재자 모달 -->
<div class="modal fade" id="approverModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5>결재선 등록</h5></div>
            <div class="modal-body">
                <input type="text" id="searchApprover" class="form-control mb-2" placeholder="🔍 검색">
                <ul id="orgTreeApprover" class="list-unstyled"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="addApproversBtn">추가</button>
                <button class="btn btn-secondary" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 참조자 모달 -->
<div class="modal fade" id="referenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5>참조자 등록</h5></div>
            <div class="modal-body">
                <input type="text" id="searchReference" class="form-control mb-2" placeholder="🔍 검색">
                <ul id="orgTreeReference" class="list-unstyled"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="addReferencesBtn">추가</button>
                <button class="btn btn-secondary" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

<script>
// 모달 강제 닫기 함수
function forceCloseModal(modalId) {
        $(modalId).modal('hide');
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        $('body').focus();
}

function buildTree(data, treeId) {
    const tree = document.getElementById(treeId);
    tree.innerHTML = "";

    const deptMap = {}, childDeptMap = {};
    data.forEach(dept => {
        if (!deptMap[dept.departmentNo]) deptMap[dept.departmentNo] = dept;
        if (!childDeptMap[dept.upperDepNo]) childDeptMap[dept.upperDepNo] = [];
        childDeptMap[dept.upperDepNo].push(dept);
    });

    const topDepts = childDeptMap[null] || childDeptMap[0] || [];
    topDepts.forEach(dept => {
        const deptLi = createDeptNodeRecursive(dept, childDeptMap);
        tree.appendChild(deptLi);
    });
}

function createDeptNodeRecursive(dept, childDeptMap) {
    const deptLi = document.createElement("li");
    deptLi.innerHTML = `<span class="toggle-icon">▶</span> 📁 <strong>${dept.departmentName} (${dept.employees.length}명)</strong>`;
    const subTree = document.createElement("ul");
    subTree.style.display = "none";

    dept.employees.forEach(emp => {
        const empLi = document.createElement("li");
        empLi.innerHTML = `
          <input type="checkbox" class="emp-check" value="${emp.employeeNo}" data-name="${emp.employeeName}">
          🙍‍♂️ ${emp.employeeName} (${emp.jobTitleName})
        `;
        subTree.appendChild(empLi);
    });

    const children = childDeptMap[dept.departmentNo] || [];
    children.forEach(child => {
        const subDeptLi = createDeptNodeRecursive(child, childDeptMap);
        subTree.appendChild(subDeptLi);
    });

    deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
        subTree.style.display = subTree.style.display === "none" ? "block" : "none";
        this.textContent = subTree.style.display === "none" ? "▶" : "▼";
    });

    deptLi.appendChild(subTree);
    return deptLi;
}

function filterTree(inputId, treeId) {
    const searchText = document.getElementById(inputId).value.toLowerCase();
    document.querySelectorAll(`#${treeId} li`).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchText) ? "" : "none";
    });
}

$('#searchApprover').on('input', () => filterTree('searchApprover', 'orgTreeApprover'));
$('#searchReference').on('input', () => filterTree('searchReference', 'orgTreeReference'));

$('#approverModal').on('show.bs.modal', function () {
    fetch('/api/orgchart')
        .then(res => res.json())
        .then(data => buildTree(data, 'orgTreeApprover'));
});

$('#referenceModal').on('show.bs.modal', function () {
    fetch('/api/orgchart')
        .then(res => res.json())
        .then(data => buildTree(data, 'orgTreeReference'));
});

$('#addApproversBtn').click(function () {
    const checked = $('#orgTreeApprover input.emp-check:checked');
    if (checked.length > 3) return alert('결재자는 최대 3명까지 선택 가능합니다.');

    const names = [], nos = [];
    checked.each(function () {
        names.push($(this).data('name'));
        nos.push($(this).val());
    });
    $('#selectedApproverList').html(names.map(n => `<li class="list-group-item">${n}</li>`).join(''));
    $('#approversInput').val(nos.join(','));
    forceCloseModal('#approverModal');
});

// 결재자 순서 변경 이벤트
// 결재자 추가 버튼 클릭 시 실행되는 함수
$('#addApproversBtn').click(function () {
    const checked = $('#orgTreeApprover input.emp-check:checked');
    if (checked.length > 3) return alert('결재자는 최대 3명까지 선택 가능합니다.');

    const names = [], nos = [];
    checked.each(function () {
        names.push($(this).data('name'));
        nos.push($(this).val());
    });

    // 결재자 목록에 항목 추가
    $('#selectedApproverList').html(names.map((n, i) => `
        <li class="list-group-item d-flex justify-content-between align-items-center" data-no="${nos[i]}">
            ${n}
            <span>
                <button type="button" class="btn btn-sm btn-outline-secondary move-up">↑</button>
                <button type="button" class="btn btn-sm btn-outline-secondary move-down">↓</button>
            </span>
        </li>
    `).join(''));

    $('#approversInput').val(nos.join(','));
    forceCloseModal('#approverModal');
});

// 결재자 순서 변경 이벤트 - 위로
$(document).on('click', '.move-up', function () {
    const li = $(this).closest('li');
    li.prev().before(li);  // 위로 이동
    updateApproversInput(); // 결재자 리스트 순서 업데이트
});

// 결재자 순서 변경 이벤트 - 아래로
$(document).on('click', '.move-down', function () {
    const li = $(this).closest('li');
    li.next().after(li);  // 아래로 이동
    updateApproversInput(); // 결재자 리스트 순서 업데이트
});

// 결재자 리스트 순서 업데이트 함수
function updateApproversInput() {
    const nos = [];
    $('#selectedApproverList li').each(function () {
        nos.push($(this).data('no'));  // 각 결재자의 employeeNo를 추출하여 배열에 저장
    });
    $('#approversInput').val(nos.join(','));  // hidden input에 순서대로 값을 업데이트
}

//참조자 추가 버튼 클릭 시 실행되는 함수
$('#addReferencesBtn').click(function () {
    const checked = $('#orgTreeReference input.emp-check:checked');
    
    if (checked.length === 0) {
        return alert('참조자를 선택해주세요.');
    }

    const names = [], nos = [];
    checked.each(function () {
        names.push($(this).data('name'));
        nos.push($(this).val());
    });

    // 참조자 목록에 항목 추가
    $('#selectedReferenceList').html(names.map(n => `
        <li class="list-group-item">${n}</li>
    `).join(''));

    // 참조자 input 값에 추가된 참조자들의 employeeNo를 설정
    $('#referencesInput').val(nos.join(','));

    forceCloseModal('#referenceModal'); // 모달 닫기
});




// 양식 불러오기
$('#formModal').on('show.bs.modal', function () {
    $.get('/aprvWriting/content', function (response) {
        const basics = response.basicsForms || [], aprvs = response.aprvForms || [];
        $('#basicsFormsList').html(basics.map(f => `<li><input type="radio" name="form" value="${f.basicsFormId}" data-type="basic"> ${f.formType}</li>`).join(''));
        $('#aprvFormsList').html(aprvs.map(f => `<li><input type="radio" name="form" value="${f.formId}" data-type="company"> ${f.formType}</li>`).join(''));
    });
});

$('#loadFormBtn').click(function () {
    const selected = $('input[name="form"]:checked');
    if (!selected.length) return alert('양식을 선택해주세요.');
    const formId = selected.val(), type = selected.data('type');
    $.get(`/aprvWriting/content/${formId}?type=${type}`, function (response) {
        $('#Content').html(response.content);
        $('#contentHidden').val(response.content);
        forceCloseModal('#formModal');
    });
});

// 임시저장 버튼 클릭 시 status를 '임시'로 설정하고 폼 제출
document.getElementById("tempSaveButton").addEventListener("click", function() {
    document.getElementById("statusInput").value = "임시";
  
    document.querySelector("form").submit();
});
</script>

</body>
</html>
