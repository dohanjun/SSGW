<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ê¸°ì•ˆë¬¸ ì‘ì„±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/approval.css}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
</head>
<body>

<div class="container mt-5">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">ê¸°ì•ˆë¬¸ ì‘ì„±</h6>
            <div>
                <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#formModal">
                    ì–‘ì‹ ì„ íƒ <span class="material-symbols-outlined">search</span>
                </button>
                <button type="button" class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#approverModal">
                    ê²°ì¬ì„ ë“±ë¡ <span class="material-symbols-outlined">search</span>
                </button>
                <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#referenceModal">
                    ì°¸ì¡°ìë“±ë¡ <span class="material-symbols-outlined">search</span>
                </button>
            </div>
        </div>
        <div class="card-body">
            <form action="/aprv/writing" method="POST">
                <input type="hidden" name="formId" id="formIdInput">
                <input type="hidden" name="basicsFormId" id="basicsFormIdInput">
                <input type="hidden" name="content" id="contentHidden">
                <input type="hidden" name="status" id="statusInput">
                <div class="form-group">
                    <label>ì œëª©</label>
                    <input type="text" class="form-control" name="title">
                </div>
                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <div id="Content" class="p-3 border rounded" style="min-height: 200px; background-color: #f8f9fc;"></div>
                    <textarea name="content" id="contentHidden" hidden></textarea>
                </div>
                <div class="form-group">
                    <label>ê²°ì¬ì</label>
                    <ul id="selectedApproverList" class="list-group mb-2"></ul>
                    <input type="hidden" name="approvers" id="approversInput">
                </div>
                <div class="form-group">
                    <label>ì°¸ì¡°ì</label>
                    <ul id="selectedReferenceList" class="list-group mb-2"></ul>
                    <input type="hidden" name="references" id="referencesInput">
                </div>

                <div class="text-right">
                    <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                    <button type="button" class="btn btn-primary" id="tempSaveButton">ì„ì‹œì €ì¥</button>
                    <button type="reset" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì–‘ì‹ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>ì–‘ì‹ ì„ íƒ</h5></div>
            <div class="modal-body">
                <h6>ê¸°ë³¸ ì–‘ì‹</h6>
                <ul id="basicsFormsList"></ul>
                <hr>
                <h6>íšŒì‚¬ ì „ìš© ì–‘ì‹</h6>
                <ul id="aprvFormsList"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                <button class="btn btn-primary" id="loadFormBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ê²°ì¬ì ëª¨ë‹¬ -->
<div class="modal fade" id="approverModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5>ê²°ì¬ì„  ë“±ë¡</h5></div>
            <div class="modal-body">
                <input type="text" id="searchApprover" class="form-control mb-2" placeholder="ğŸ” ê²€ìƒ‰">
                <ul id="orgTreeApprover" class="list-unstyled"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="addApproversBtn">ì¶”ê°€</button>
                <button class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ì°¸ì¡°ì ëª¨ë‹¬ -->
<div class="modal fade" id="referenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5>ì°¸ì¡°ì ë“±ë¡</h5></div>
            <div class="modal-body">
                <input type="text" id="searchReference" class="form-control mb-2" placeholder="ğŸ” ê²€ìƒ‰">
                <ul id="orgTreeReference" class="list-unstyled"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="addReferencesBtn">ì¶”ê°€</button>
                <button class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

<script>
// ëª¨ë‹¬ ê°•ì œ ë‹«ê¸° í•¨ìˆ˜
function forceCloseModal(modalId) {
        $(modalId).modal('hide');
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        $('body').focus();
}

function buildTree(data, treeId) {
    const tree = document.getElementById(treeId);
    tree.innerHTML = "";

    const deptMap = {}, childDeptMap = {};
    data.forEach(dept => {
        if (!deptMap[dept.departmentNo]) deptMap[dept.departmentNo] = dept;
        if (!childDeptMap[dept.upperDepNo]) childDeptMap[dept.upperDepNo] = [];
        childDeptMap[dept.upperDepNo].push(dept);
    });

    const topDepts = childDeptMap[null] || childDeptMap[0] || [];
    topDepts.forEach(dept => {
        const deptLi = createDeptNodeRecursive(dept, childDeptMap);
        tree.appendChild(deptLi);
    });
}

function createDeptNodeRecursive(dept, childDeptMap) {
    const deptLi = document.createElement("li");
    deptLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong>${dept.departmentName} (${dept.employees.length}ëª…)</strong>`;
    const subTree = document.createElement("ul");
    subTree.style.display = "none";

    dept.employees.forEach(emp => {
        const empLi = document.createElement("li");
        empLi.innerHTML = `
          <input type="checkbox" class="emp-check" value="${emp.employeeNo}" data-name="${emp.employeeName}">
          ğŸ™â€â™‚ï¸ ${emp.employeeName} (${emp.jobTitleName})
        `;
        subTree.appendChild(empLi);
    });

    const children = childDeptMap[dept.departmentNo] || [];
    children.forEach(child => {
        const subDeptLi = createDeptNodeRecursive(child, childDeptMap);
        subTree.appendChild(subDeptLi);
    });

    deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
        subTree.style.display = subTree.style.display === "none" ? "block" : "none";
        this.textContent = subTree.style.display === "none" ? "â–¶" : "â–¼";
    });

    deptLi.appendChild(subTree);
    return deptLi;
}

function filterTree(inputId, treeId) {
    const searchText = document.getElementById(inputId).value.toLowerCase();
    document.querySelectorAll(`#${treeId} li`).forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchText) ? "" : "none";
    });
}

$('#searchApprover').on('input', () => filterTree('searchApprover', 'orgTreeApprover'));
$('#searchReference').on('input', () => filterTree('searchReference', 'orgTreeReference'));

$('#approverModal').on('show.bs.modal', function () {
    fetch('/api/orgchart')
        .then(res => res.json())
        .then(data => buildTree(data, 'orgTreeApprover'));
});

$('#referenceModal').on('show.bs.modal', function () {
    fetch('/api/orgchart')
        .then(res => res.json())
        .then(data => buildTree(data, 'orgTreeReference'));
});

$('#addApproversBtn').click(function () {
    const checked = $('#orgTreeApprover input.emp-check:checked');
    if (checked.length > 3) return alert('ê²°ì¬ìëŠ” ìµœëŒ€ 3ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');

    const names = [], nos = [];
    checked.each(function () {
        names.push($(this).data('name'));
        nos.push($(this).val());
    });
    $('#selectedApproverList').html(names.map(n => `<li class="list-group-item">${n}</li>`).join(''));
    $('#approversInput').val(nos.join(','));
    forceCloseModal('#approverModal');
});

// ê²°ì¬ì ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸
// ê²°ì¬ì ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
$('#addApproversBtn').click(function () {
    const checked = $('#orgTreeApprover input.emp-check:checked');
    if (checked.length > 3) return alert('ê²°ì¬ìëŠ” ìµœëŒ€ 3ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');

    const names = [], nos = [];
    checked.each(function () {
        names.push($(this).data('name'));
        nos.push($(this).val());
    });

    // ê²°ì¬ì ëª©ë¡ì— í•­ëª© ì¶”ê°€
    $('#selectedApproverList').html(names.map((n, i) => `
        <li class="list-group-item d-flex justify-content-between align-items-center" data-no="${nos[i]}">
            ${n}
            <span>
                <button type="button" class="btn btn-sm btn-outline-secondary move-up">â†‘</button>
                <button type="button" class="btn btn-sm btn-outline-secondary move-down">â†“</button>
            </span>
        </li>
    `).join(''));

    $('#approversInput').val(nos.join(','));
    forceCloseModal('#approverModal');
});

// ê²°ì¬ì ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ - ìœ„ë¡œ
$(document).on('click', '.move-up', function () {
    const li = $(this).closest('li');
    li.prev().before(li);  // ìœ„ë¡œ ì´ë™
    updateApproversInput(); // ê²°ì¬ì ë¦¬ìŠ¤íŠ¸ ìˆœì„œ ì—…ë°ì´íŠ¸
});

// ê²°ì¬ì ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ - ì•„ë˜ë¡œ
$(document).on('click', '.move-down', function () {
    const li = $(this).closest('li');
    li.next().after(li);  // ì•„ë˜ë¡œ ì´ë™
    updateApproversInput(); // ê²°ì¬ì ë¦¬ìŠ¤íŠ¸ ìˆœì„œ ì—…ë°ì´íŠ¸
});

// ê²°ì¬ì ë¦¬ìŠ¤íŠ¸ ìˆœì„œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateApproversInput() {
    const nos = [];
    $('#selectedApproverList li').each(function () {
        nos.push($(this).data('no'));  // ê° ê²°ì¬ìì˜ employeeNoë¥¼ ì¶”ì¶œí•˜ì—¬ ë°°ì—´ì— ì €ì¥
    });
    $('#approversInput').val(nos.join(','));  // hidden inputì— ìˆœì„œëŒ€ë¡œ ê°’ì„ ì—…ë°ì´íŠ¸
}

//ì°¸ì¡°ì ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
$('#addReferencesBtn').click(function () {
    const checked = $('#orgTreeReference input.emp-check:checked');
    
    if (checked.length === 0) {
        return alert('ì°¸ì¡°ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }

    const names = [], nos = [];
    checked.each(function () {
        names.push($(this).data('name'));
        nos.push($(this).val());
    });

    // ì°¸ì¡°ì ëª©ë¡ì— í•­ëª© ì¶”ê°€
    $('#selectedReferenceList').html(names.map(n => `
        <li class="list-group-item">${n}</li>
    `).join(''));

    // ì°¸ì¡°ì input ê°’ì— ì¶”ê°€ëœ ì°¸ì¡°ìë“¤ì˜ employeeNoë¥¼ ì„¤ì •
    $('#referencesInput').val(nos.join(','));

    forceCloseModal('#referenceModal'); // ëª¨ë‹¬ ë‹«ê¸°
});




// ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°
$('#formModal').on('show.bs.modal', function () {
    $.get('/aprvWriting/content', function (response) {
        const basics = response.basicsForms || [], aprvs = response.aprvForms || [];
        $('#basicsFormsList').html(basics.map(f => `<li><input type="radio" name="form" value="${f.basicsFormId}" data-type="basic"> ${f.formType}</li>`).join(''));
        $('#aprvFormsList').html(aprvs.map(f => `<li><input type="radio" name="form" value="${f.formId}" data-type="company"> ${f.formType}</li>`).join(''));
    });
});

$('#loadFormBtn').click(function () {
    const selected = $('input[name="form"]:checked');
    if (!selected.length) return alert('ì–‘ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    const formId = selected.val(), type = selected.data('type');
    $.get(`/aprvWriting/content/${formId}?type=${type}`, function (response) {
        $('#Content').html(response.content);
        $('#contentHidden').val(response.content);
        forceCloseModal('#formModal');
    });
});

// ì„ì‹œì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ statusë¥¼ 'ì„ì‹œ'ë¡œ ì„¤ì •í•˜ê³  í¼ ì œì¶œ
document.getElementById("tempSaveButton").addEventListener("click", function() {
    document.getElementById("statusInput").value = "ì„ì‹œ";
  
    document.querySelector("form").submit();
});
</script>

</body>
</html>
