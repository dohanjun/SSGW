<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ê¸°ì•ˆë¬¸ ì‘ì„±</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/approval.css}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
</head>
<body>

<div class="container mt-5">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">ê¸°ì•ˆë¬¸ ì‘ì„±</h6>
            <div>
                <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#formModal">
                    ì–‘ì‹ ì„ íƒ <span class="material-symbols-outlined">search</span>
                </button>
                <button type="button" class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#approverModal">
                    ê²°ì¬ì„ ë“±ë¡ <span class="material-symbols-outlined">search</span>
                </button>
                <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#referenceModal">
                    ì°¸ì¡°ìë“±ë¡ <span class="material-symbols-outlined">search</span>
                </button>
            </div>
        </div>
        <div class="card-body">
            <form action="/aprv/writing" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="formId" id="formIdInput">
                <input type="hidden" name="basicsFormId" id="basicsFormIdInput">
                <input type="hidden" name="aprvStatus" id="statusInput">
                <input type="hidden" name="vacationTypeId" id="vacationTypeIdInput">
                <input type="hidden" name="content" id="contentHidden" th:value="${aprvVO != null} ? ${aprvVO.content} : ''" />
                <div class="form-group">
                    <label>ì œëª©</label>
                    <input type="text" class="form-control" name="title"
                           th:value="${aprvVO != null} ? ${aprvVO.title} : ''">
                </div>
                <!-- íœ´ê°€ìœ í˜• ì…€ë ‰íŠ¸ë°•ìŠ¤ -->
				<div class="form-group" id="vacationTypeSelector" style="display: none;">
				    <label>íœ´ê°€ ìœ í˜• ì„ íƒ</label>
				    <select id="vacationTypeSelect" class="form-control">
				        <option disabled selected>íœ´ê°€ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</option>
				    </select>
				</div>
                <div class="form-group">
                    <label>ë‚´ìš©</label>
                    <div id="Content" class="p-3 border rounded"  style="min-height: 200px; background-color: #f8f9fc;" contenteditable="true"></div>
                </div>
                <div class="form-group">
    				<label>ì²¨ë¶€íŒŒì¼</label>
    				<input type="file" name="files" id="fileInput" class="form-control" multiple>
				</div>
                <div class="form-group">
                    <label>ê²°ì¬ì</label>
                    <ul id="selectedApproverList" class="list-group mb-2"></ul>
                    <input type="hidden" name="approvers" id="approversInput">
                </div>
                <div class="form-group">
                    <label>ì°¸ì¡°ì</label>
                    <ul id="selectedReferenceList" class="list-group mb-2"></ul>
                    <input type="hidden" name="references" id="referencesInput">
                </div>

                <div class="text-right">
                    <button type="button" class="btn btn-primary" id="ajaxSubmitBtn">ë“±ë¡</button>
                    <button type="button" class="btn btn-primary" id="tempSaveButton">ì„ì‹œì €ì¥</button>
                    <button type="reset" class="btn btn-secondary">ì´ˆê¸°í™”</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì–‘ì‹ ì„ íƒ ëª¨ë‹¬ -->
<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>ì–‘ì‹ ì„ íƒ</h5></div>
            <div class="modal-body">
                <h6>ê¸°ë³¸ ì–‘ì‹</h6>
                <ul id="basicsFormsList"></ul>
                <hr>
                <h6>íšŒì‚¬ ì „ìš© ì–‘ì‹</h6>
                <ul id="aprvFormsList"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
                <button class="btn btn-primary" id="loadFormBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ê²°ì¬ì ëª¨ë‹¬ -->
<div class="modal fade" id="approverModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5>ê²°ì¬ì„  ë“±ë¡</h5></div>
            <div class="modal-body">
                <input type="text" id="searchApprover" class="form-control mb-2" placeholder="ğŸ” ê²€ìƒ‰">
                <ul id="orgTreeApprover" class="list-unstyled"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="addApproversBtn">ì¶”ê°€</button>
                <button class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- ì°¸ì¡°ì ëª¨ë‹¬ -->
<div class="modal fade" id="referenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header"><h5>ì°¸ì¡°ì ë“±ë¡</h5></div>
            <div class="modal-body">
                <input type="text" id="searchReference" class="form-control mb-2" placeholder="ğŸ” ê²€ìƒ‰">
                <ul id="orgTreeReference" class="list-unstyled"></ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="addReferencesBtn">ì¶”ê°€</button>
                <button class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>

<script>
// ëª¨ë‹¬ ê°•ì œ ë‹«ê¸° í•¨ìˆ˜
function forceCloseModal(modalId) {
        $(modalId).modal('hide');
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        $('body').focus();
}

document.addEventListener("DOMContentLoaded", function () {
    fetch("/api/orgchart")
        .then(response => response.json())
        .then(data => {
            console.log("[ì¡°ì§ë„ ë°ì´í„°]", data);
            buildOrgChart(data, "orgTreeApprover"); // ê²°ì¬ììš© íŠ¸ë¦¬
            buildOrgChart(data, "orgTreeReference"); // ì°¸ì¡°ììš© íŠ¸ë¦¬
        })
        .catch(error => console.error("ì¡°ì§ë„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
});

// íšŒì‚¬ë³„ë¡œ êµ¬ë¶„í•´ì„œ ì¡°ì§ë„ êµ¬ì„±

function buildOrgChart(data, treeId) {
    const tree = document.getElementById(treeId);
    tree.innerHTML = "";

    const companyMap = {};

    // suberNo ê¸°ì¤€ìœ¼ë¡œ íšŒì‚¬ ê·¸ë£¹í•‘
    data.forEach(item => {
        if (!companyMap[item.suberNo]) {
            companyMap[item.suberNo] = {
                companyName: item.companyName,
                departments: []
            };
        }
        companyMap[item.suberNo].departments.push(item);
    });

    Object.values(companyMap).forEach(company => {
        const companyLi = document.createElement("li");
        companyLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ¢ <strong>${company.companyName}</strong>`;

        const deptTree = document.createElement("ul");
        deptTree.style.display = "block";
        companyLi.querySelector(".toggle-icon").textContent = "â–¼";

        // ë¶€ì„œ íŠ¸ë¦¬ êµ¬ì¡°í™”
        buildDeptTree(company.departments, deptTree);

        companyLi.appendChild(deptTree);
        tree.appendChild(companyLi);

        // í† ê¸€
        companyLi.querySelector(".toggle-icon").addEventListener("click", function () {
            deptTree.style.display = deptTree.style.display === "none" ? "block" : "none";
            this.textContent = deptTree.style.display === "none" ? "â–¶" : "â–¼";
        });
    });
}

// ë¶€ì„œë¥¼ ê³„ì¸µì ìœ¼ë¡œ ì—°ê²°í•´ì„œ íŠ¸ë¦¬ ìƒì„±
function buildDeptTree(departments, containerUl) {
    const childDeptMap = {};

    departments.forEach(dept => {
        if (!childDeptMap[dept.upperDepNo]) childDeptMap[dept.upperDepNo] = [];
        childDeptMap[dept.upperDepNo].push(dept);
    });

    // ìƒìœ„ ë¶€ì„œê°€ ëª©ë¡ì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìµœìƒìœ„ ë¶€ì„œë¡œ ê°„ì£¼
    const allDeptNos = departments.map(d => d.departmentNo);
    const topDepts = departments.filter(d => !allDeptNos.includes(d.upperDepNo));

    topDepts.forEach(dept => {
        const deptLi = createDeptNodeRecursive(dept, childDeptMap);
        containerUl.appendChild(deptLi);
    });
}

function createDeptNodeRecursive(dept, childDeptMap) {
    const deptLi = document.createElement("li");
    const empCount = (dept.employees && dept.employees.length) || 0;
    deptLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong>${dept.departmentName} (${empCount}ëª…)</strong>`;

    const subTree = document.createElement("ul");
    subTree.style.display = "none";

    // ì‚¬ì› ì²´í¬ë°•ìŠ¤ ì¶”ê°€
    if (dept.employees) {
        dept.employees.forEach(emp => {
            const empLi = document.createElement("li");
            empLi.innerHTML = `
                <input type="checkbox" class="emp-check" 
                       value="${emp.employeeNo}" 
                       data-name="${emp.employeeName}" 
                       data-job="${emp.jobTitleName}">
                ğŸ™â€â™‚ï¸ ${emp.employeeName} (${emp.jobTitleName})
            `;
            subTree.appendChild(empLi);
        });
    }

    // í•˜ìœ„ ë¶€ì„œ ì¬ê·€ í˜¸ì¶œ
    const children = childDeptMap[dept.departmentNo] || [];
    children.forEach(child => {
        const subDeptLi = createDeptNodeRecursive(child, childDeptMap);
        subTree.appendChild(subDeptLi);
    });

    // í† ê¸€ ì´ë²¤íŠ¸
    deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
        subTree.style.display = subTree.style.display === "none" ? "block" : "none";
        this.textContent = subTree.style.display === "none" ? "â–¶" : "â–¼";
    });

    deptLi.appendChild(subTree);
    return deptLi;
}

// ê²€ìƒ‰ ê¸°ëŠ¥ (íŠ¸ë¦¬ ìë™ í¼ì¹¨ í¬í•¨)
function filterTree(inputId, treeId) {
    const searchText = document.getElementById(inputId).value.toLowerCase();
    const allItems = document.querySelectorAll(`#${treeId} li`);

    allItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        const match = text.includes(searchText);
        item.style.display = match ? "" : "none";

        // ê²€ìƒ‰ëœ í•­ëª©ì´ ë³´ì¼ ê²½ìš° ìƒìœ„ íŠ¸ë¦¬ë„ í¼ì¹˜ê¸°
        if (match) {
            let parent = item.parentElement;
            while (parent && parent.id !== treeId) {
                if (parent.tagName === "UL") parent.style.display = "block";
                if (parent.tagName === "LI") {
                    const toggle = parent.querySelector(".toggle-icon");
                    if (toggle) toggle.textContent = "â–¼";
                }
                parent = parent.parentElement;
            }
        }
    });
}

// ê²€ìƒ‰ ì´ë²¤íŠ¸ ì—°ê²°
$('#searchApprover').on('input', () => filterTree('searchApprover', 'orgTreeApprover'));
$('#searchReference').on('input', () => filterTree('searchReference', 'orgTreeReference'));
// ì—¬ê¸°ê¹Œì§€ ì¡°ì§ë„

// ëª¨ë‹¬ì°½ì—´ê¸°
$('#approverModal').on('show.bs.modal', function () {
    fetch('/api/orgchart')
        .then(res => res.json())
        .then(data => {
        	console.log("[ì¡°ì§ë„ ë°ì´í„°]", data);
        	buildOrgChart(data, 'orgTreeApprover')});
});

$('#referenceModal').on('show.bs.modal', function () {
    fetch('/api/orgchart')
        .then(res => res.json())
        .then(data => buildOrgChart(data, 'orgTreeReference'));
});

// ê²°ì¬ì ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸
// ê²°ì¬ì ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
$('#addApproversBtn').click(function () {
    const checked = $('#orgTreeApprover input.emp-check:checked');
    if (checked.length > 3) return alert('ê²°ì¬ìëŠ” ìµœëŒ€ 3ëª…ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');

    const names = [], nos = [], jobTitles = [];
    checked.each(function () {
        const name = $(this).data('name');
        const job = $(this).data('job');
        const no = $(this).val();

        names.push(`${name} (${job})`);
        nos.push(no);
    });

    $('#selectedApproverList').html(names.map((n, i) => `
        <li class="list-group-item d-flex justify-content-between align-items-center" data-no="${nos[i]}">
            ${n}
            <span>
                <button type="button" class="btn btn-sm btn-outline-secondary move-up">â†‘</button>
                <button type="button" class="btn btn-sm btn-outline-secondary move-down">â†“</button>
            </span>
        </li>
    `).join(''));

    $('#approversInput').val(nos.join(','));
    forceCloseModal('#approverModal');
});

// ê²°ì¬ì ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ - ìœ„ë¡œ
$(document).on('click', '.move-up', function () {
    const li = $(this).closest('li');
    li.prev().before(li);  // ìœ„ë¡œ ì´ë™
    updateApproversInput(); // ê²°ì¬ì ë¦¬ìŠ¤íŠ¸ ìˆœì„œ ì—…ë°ì´íŠ¸
});

// ê²°ì¬ì ìˆœì„œ ë³€ê²½ ì´ë²¤íŠ¸ - ì•„ë˜ë¡œ
$(document).on('click', '.move-down', function () {
    const li = $(this).closest('li');
    li.next().after(li);  // ì•„ë˜ë¡œ ì´ë™
    updateApproversInput(); // ê²°ì¬ì ë¦¬ìŠ¤íŠ¸ ìˆœì„œ ì—…ë°ì´íŠ¸
});

// ê²°ì¬ì ë¦¬ìŠ¤íŠ¸ ìˆœì„œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateApproversInput() {
    const nos = [];
    $('#selectedApproverList li').each(function () {
        nos.push($(this).data('no'));  // ê° ê²°ì¬ìì˜ employeeNoë¥¼ ì¶”ì¶œí•˜ì—¬ ë°°ì—´ì— ì €ì¥
    });
    $('#approversInput').val(nos.join(','));  // hidden inputì— ìˆœì„œëŒ€ë¡œ ê°’ì„ ì—…ë°ì´íŠ¸
}

//ì°¸ì¡°ì ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
$('#addReferencesBtn').click(function () {
    const checked = $('#orgTreeReference input.emp-check:checked');
    
    if (checked.length === 0) {
        return alert('ì°¸ì¡°ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }

    const names = [], nos = [];
    checked.each(function () {
    	const name = $(this).data('name');
        const job = $(this).data('job');
        
        names.push(`${name} (${job})`);
        nos.push($(this).val());
    });

    // ì°¸ì¡°ì ëª©ë¡ì— í•­ëª© ì¶”ê°€
    $('#selectedReferenceList').html(names.map(n => `
        <li class="list-group-item">${n}</li>
    `).join(''));

    // ì°¸ì¡°ì input ê°’ì— ì¶”ê°€ëœ ì°¸ì¡°ìë“¤ì˜ employeeNoë¥¼ ì„¤ì •
    $('#referencesInput').val(nos.join(','));

    forceCloseModal('#referenceModal'); // ëª¨ë‹¬ ë‹«ê¸°
});




// ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸°
$('#formModal').on('show.bs.modal', function () {
    $.get('/aprvWriting/content', function (response) {
        const basics = response.basicsForms || [], aprvs = response.aprvForms || [];
        $('#basicsFormsList').html(basics.map(f => `<li><input type="radio" name="form" value="${f.basicsFormId}" data-type="basic"> ${f.formType}</li>`).join(''));
        $('#aprvFormsList').html(aprvs.map(f => `<li><input type="radio" name="form" value="${f.formId}" data-type="company"> ${f.formType}</li>`).join(''));
    });
});

//ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
$('#loadFormBtn').click(function () {
    const selected = $('input[name="form"]:checked');
    if (!selected.length) return alert('ì–‘ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

    const formId = selected.val();
    const type = selected.data('type');

    $.get(`/aprvWriting/content/${formId}?type=${type}`, function (response) {
        const formType = response.formType;
        $('#Content').html(response.content);
        $('#contentHidden').val(response.content);
		
        if (type === 'company') {
            $('#formIdInput').val(formId);
            $('#basicsFormIdInput').val('');
        } else {
            $('#basicsFormIdInput').val(formId);
            $('#formIdInput').val('');
        }
        
        forceCloseModal('#formModal');

        // ğŸ‘‰ íœ´ê°€ì› ì–‘ì‹ì¼ ê²½ìš° íœ´ê°€ìœ í˜• ì…€ë ‰íŠ¸ í‘œì‹œ + ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        if (formType === 'íœ´ê°€ì›') {
            $('#vacationTypeSelector').show();
            $('#vacationTypeSelect').empty().append(`<option disabled selected>íœ´ê°€ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</option>`);

            // íšŒì‚¬ë³„ íœ´ê°€ìœ í˜• ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            $.get('/aprv/vacation', function (types) {
                const uniqueTypes = [...new Map(types.map(t => [t.vacationTypeName, t])).values()];
                uniqueTypes.forEach(type => {
                    $('#vacationTypeSelect').append(`<option value="${type.vacationTypeName}" data-id="${type.vacationTypeId}">${type.vacationTypeName}</option>`);
                });
            });

        } else {
            // íœ´ê°€ì›ì´ ì•„ë‹ˆë©´ ì…€ë ‰íŠ¸ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
            $('#vacationTypeSelector').hide();
        }
    });
});

// íœ´ê°€ìœ í˜• ì„ íƒ ì‹œ íœ´ê°€ì› ì–‘ì‹ ë‚´ë¶€ inputì— ë°˜ì˜
$('#vacationTypeSelect').on('change', function () {
    const selectedType = $(this).val();
    const selectedId = $(this).find('option:selected').data('id');
    
    // íœ´ê°€ì¢…ë¥˜ input ì°¾ê¸° â†’ value ì„¤ì •
    $('#Content').find('table.vacationtable input[type="text"]').each(function () {
        const thText = $(this).closest('tr').find('th').text().trim();
        if (thText.includes('íœ´ê°€ì¢…ë¥˜')) {
            $(this).val(selectedType);
        }
    });
    
    $('#vacationTypeIdInput').val(selectedId);
    
    // contentHiddenì—ë„ ë°˜ì˜
    const finalContent = prepareFinalContent();
    $('#contentHidden').val(finalContent);
});

document.addEventListener("DOMContentLoaded", function () {
    const contentHidden = document.getElementById("contentHidden");

    if (contentHidden && contentHidden.value) {
        // HTML Entity ë””ì½”ë”©
        const textarea = document.createElement("textarea");
        textarea.innerHTML = contentHidden.value;
        const decodedHtml = textarea.value;

        // ì½˜í…ì¸  ì˜ì—­ì— HTML ì‚½ì…
        document.getElementById("Content").innerHTML = decodedHtml;
    }
});

// ì „ì†¡
$('#ajaxSubmitBtn').on('click', function () {
    const finalContent = prepareFinalContent();
    const title = $('input[name="title"]').val().trim();
    const draftNo = new URLSearchParams(window.location.search).get("draftNo");
	
    if (!title && !finalContent) {
        alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    } else if (!title) {
        alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    } else if (!finalContent) {
        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }
    
    if (draftNo) {
        $.ajax({
            url: '/aprv/removeTemporaryData',  // ì„ì‹œì €ì¥ëœ ë°ì´í„° ì‚­ì œ ìš”ì²­
            type: 'POST',
            data: { draftNo: draftNo },
            success: function(response) {
                if (response.success) {
                    console.log('ì„ì‹œì €ì¥ëœ ë°ì´í„° ì‚­ì œ ì„±ê³µ');
                } else {
                    console.log('ì„ì‹œì €ì¥ëœ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨');
                }
            },
            error: function(err) {
                console.log('Ajax ìš”ì²­ ì‹¤íŒ¨:', err);
            }
        });
    }
    
    
    // FormData ìƒì„±
    const form = document.querySelector("form");
    const formData = new FormData(form);

    // ê¸°ë³¸ ë°ì´í„° ì¶”ê°€
    formData.append("title", $('input[name="title"]').val());
    formData.append("content", finalContent);
    formData.append("status", "ëŒ€ê¸°");
    formData.append("formId", $('#formIdInput').val());
    formData.append("basicsFormId", $('#basicsFormIdInput').val());
    formData.append("vacationTypeId", $('#vacationTypeIdInput').val());

    //  formType ì¶”ì¶œ ë° ì¶”ê°€
    const formType = $('#Content').find('.vacationtitle').text().trim();  // ì˜ˆ: 'íœ´ê°€ì›'
    formData.append("formType", formType);

    //  íœ´ê°€ì›ì¼ ë•Œë§Œ ì‹œì‘ì¼/ì¢…ë£Œì¼/íœ´ê°€ì¼ìˆ˜ ê³„ì‚°
    if (formType === 'íœ´ê°€ì›') {
        const dateInputs = $('#Content').find('table.vacationtable input[type="date"]');
        const startDate = dateInputs.eq(0).val();
        const endDate = dateInputs.eq(1).val();
        let usedDays = "";

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (end >= start) {
                usedDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            }
        }

        formData.append("startDate", startDate);
        formData.append("endDate", endDate);
        formData.append("usedVacation", usedDays);
    }

    // íŒŒì¼ ì²¨ë¶€ ì²˜ë¦¬
    const fileInput = document.getElementById("fileInput");
    const files = fileInput.files;
    for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
    }

    // ê²°ì¬ì (í•„ìˆ˜)
    const approvers = $('#approversInput').val();
    if (!approvers) {
        alert("ê²°ì¬ìë¥¼ í•œ ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }
    approvers.split(',').forEach(a => {
        formData.append("approvers", a);
    });

    // ì°¸ì¡°ì (ì„ íƒ)
    const references = $('#referencesInput').val();
    if (references) {
        references.split(',').forEach(r => {
            formData.append("references", r);
        });
    }

    // ì „ì†¡
    $.ajax({
        url: '/aprv/writing',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function () {
            alert('ê¸°ì•ˆë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.href = '/aprv/request';
        },
        error: function (xhr) {
            alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + xhr.responseText);
        }
    });
});

// ì–‘ì‹ ë¶ˆëŸ¬ì˜¨ í›„ ë‚´ìš© ì±„ì›Œë„£ê³  ë“±ë¡
function prepareFinalContent() {
    const contentDiv = document.getElementById("Content");
    const clonedContent = contentDiv.cloneNode(true);

    // input
    clonedContent.querySelectorAll("input").forEach(input => {
        if (input.type === "checkbox" || input.type === "radio") {
            if (input.checked) input.setAttribute("checked", "checked");
            else input.removeAttribute("checked");
        } else {
            input.setAttribute("value", input.value);
        }
    });

    // textarea
    clonedContent.querySelectorAll("textarea").forEach(textarea => {
        textarea.innerHTML = textarea.value;
    });

    // select
    clonedContent.querySelectorAll("select").forEach(select => {
        Array.from(select.options).forEach(option => {
            if (option.value === select.value) {
                option.setAttribute("selected", "selected");
            } else {
                option.removeAttribute("selected");
            }
        });
    });

    return clonedContent.innerHTML;
}

// ì„ì‹œì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ statusë¥¼ 'ì„ì‹œ'ë¡œ ì„¤ì •í•˜ê³  í¼ ì œì¶œ
document.getElementById("tempSaveButton").addEventListener("click", function () {
	const title = $('input[name="title"]').val().trim();
    const finalContent = prepareFinalContent().trim();
    
    if (!title && !finalContent) {
        alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    } else if (!title) {
        alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    } else if (!finalContent) {
        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }
    
    const form = document.querySelector("form");
    const formData = new FormData(form);

    formData.append("title", $('input[name="title"]').val());
    formData.append("content", finalContent);
    formData.append("aprvStatus", "ì„ì‹œ");

    const fileInput = document.getElementById("fileInput");
    const files = fileInput.files;
    for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
    }

    const approvers = $('#approversInput').val();
    if (approvers) {
        approvers.split(',').forEach(a => {
            formData.append("approvers", a);
        });
    }

    const references = $('#referencesInput').val();
    if (references) {
        references.split(',').forEach(r => {
            formData.append("references", r);
        });
    }

    $.ajax({
        url: '/aprv/writing',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function () {
            alert('ì„ì‹œì €ì¥ ë˜ì—ˆìŠµë‹ˆë‹¤!');
            location.href = '/aprv/request?aprvStatus=ì„ì‹œ';
        },
        error: function (xhr) {
            alert('ì œëª©, ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        }
    });
});

// íœ´ê°€ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
$.get('/aprv/vacation', function (types) {
    const uniqueTypes = [...new Map(types.map(t => [t.vacationTypeName, t])).values()];
    uniqueTypes.forEach(type => {
        $('#vacationTypeSelect').append(`<option value="${type.vacationTypeName}">${type.vacationTypeName}</option>`);
    });
});

// ì´ì•¡ ê³„ì‚° í•¨ìˆ˜ ì •ì˜ (ì½¤ë§ˆ í¬í•¨)
function updateTotal($container) {
    let total = 0;
    $container.find('table.distable').eq(1).find('input[type="number"]').each(function () {
        const value = parseInt($(this).val().replace(/,/g, '')) || 0;
        total += value;
    });
    // ìˆ«ìë¥¼ ì½¤ë§ˆë¡œ ë³€í™˜í•˜ì—¬ ì´í•© í•„ë“œì— í‘œì‹œ (textë¡œ ë³€ê²½í–ˆìœ¼ë¯€ë¡œ ì •ìƒ í‘œì‹œë¨)
    $container.find('table.distable').eq(2).find('input[type="text"]').val(total.toLocaleString());
}

//  í–‰ ì¶”ê°€ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
$(document).on('click', '#addDisRowBtn', function () {
    const newRow = `
        <tr>
            <td><input type="text" class="input-field"></td>
            <td><input type="text" class="input-field"></td>
            <td>
                <div class="d-flex justify-content-between align-items-center">
                    <input type="number" class="input-field text-right" style="flex: 1;">
                    <button type="button" class="btn btn-sm btn-danger ml-2 remove-dis-row">ì‚­ì œ</button>
                </div>
            </td>
        </tr>
    `;
    const $disburdd = $(this).closest('.disburdd');
    $disburdd.find('table.distable').eq(1).append(newRow);
    updateTotal($disburdd);  // ì´í•© ë‹¤ì‹œ ê³„ì‚°
});

$(document).on('click', '.remove-dis-row', function () {
    const $row = $(this).closest('tr');
    const $disburdd = $row.closest('.disburdd');
    $row.remove();
    updateTotal($disburdd);  // ì´í•© ë‹¤ì‹œ ê³„ì‚°
});


//  ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì´í•© ì—…ë°ì´íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
$(document).on('input', '.disburdd table.distable:eq(1) input[type="number"]', function () {
    const $disburdd = $(this).closest('.disburdd');
    updateTotal($disburdd);
});

//  ì–‘ì‹ ë¡œë”© í›„ ì´ˆê¸° ì´ì•¡ ê³„ì‚°
function initDisbursementForm() {
    const $disburdd = $('.disburdd');
    if ($disburdd.length > 0) {
        updateTotal($disburdd);
    }
}

// ê²°ì¬ì ì¶”ê°€
document.getElementById("addRowBtn").addEventListener("click", function () {
    const tbody = document.getElementById("approvalTableBody");

    const newRow = document.createElement("tr");
    newRow.innerHTML = `
        <td><input type="text" name="approverName" class="form-control"></td>
        <td><button type="button" class="btn btn-danger btn-sm removeRowBtn">ì‚­ì œ</button></td>
    `;

    tbody.appendChild(newRow);
});



// í–‰ ì‚­ì œ ì²˜ë¦¬
document.getElementById("approvalTableBody").addEventListener("click", function (event) {
    if (event.target && event.target.classList.contains("removeRowBtn")) {
        const row = event.target.closest("tr");
        row.remove(); // í•´ë‹¹ í–‰ ì‚­ì œ
    }
});

</script>

</body>
</html>
