<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ì¡°ì§ë„</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa !important;
        }

        .container-fluid {
            padding: 30px 60px;
        }

        .card-box {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #fff;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 750px; /* ì¹´ë“œ í¬ê¸° ìœ ì§€ */
            width: 1300px;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #333;
            text-align: center;
        }

        #orgTree, #orgTree ul {
            list-style: none;
            padding-left: 10px;
        }

        #orgTree li {
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            position: relative;
        }

        .toggle-icon {
            cursor: pointer;
            margin-right: 5px;
        }

        #searchInput {
            font-size: 14px;
            padding: 8px;
        }

        .company-name {
            font-weight: bold;
            font-size: 20px;
            color: #007bff;
            margin-bottom: 10px;
        }

        .profile-box {
            width: 120px;
            height: 120px;
            border: 1px solid #ccc;
            border-radius: 6px;
            overflow: hidden;
            margin: 0 auto 15px;
        }

        .profile-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .emp-info-group {
            display: flex;
            justify-content: center;
            margin-bottom: 6px;
        }

        .emp-info-label {
            width: 60px;
            text-align: right;
            font-weight: bold;
            margin-right: 8px;
        }

        .emp-info-value {
            text-align: left;
            min-width: 200px;
        }

        /* íŠ¸ë¦¬ ì˜ì—­ ë†’ì´ ì œí•œ */
        .org-tree-wrapper {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* ì§ì› ì •ë³´ ì¹´ë“œ ë°•ìŠ¤ */
        .emp-info-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 25px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card-box">
        <div class="card-title">ì¡°ì§ë„</div>

        <div class="row">
            <!-- ì¡°ì§ë„ íŠ¸ë¦¬ -->
            <div class="col-md-6 org-tree-wrapper">
                <input type="text" id="searchInput" class="form-control mb-3" placeholder="ğŸ” ê²€ìƒ‰">
                <ul id="orgTree" class="list-unstyled"></ul>
            </div>

            <!-- ì§ì› ì •ë³´ -->
            <div class="col-md-6">
                <div class="emp-info-card text-center">
                    <h5 class="font-weight-bold mb-3">ì§ì› ì •ë³´</h5>
                    <div class="profile-box">
                        <img id="empImage" src="" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" style="display: none;">
                    </div>
                    <div class="emp-info-group">
                        <div class="emp-info-label">ì´ë¦„:</div>
                        <div class="emp-info-value" id="empName">-</div>
                    </div>
                    <div class="emp-info-group">
                        <div class="emp-info-label">ë¶€ì„œ:</div>
                        <div class="emp-info-value" id="empDept">-</div>
                    </div>
                    <div class="emp-info-group">
                        <div class="emp-info-label">ì§ê¸‰:</div>
                        <div class="emp-info-value" id="empTitle">-</div>
                    </div>
                    <div class="emp-info-group">
                        <div class="emp-info-label">ì—°ë½ì²˜:</div>
                        <div class="emp-info-value" id="empPhone">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>





<script>
		document.addEventListener("DOMContentLoaded", function () {
		    fetch("/api/orgchart")
		        .then(response => response.json())
		        .then(data => {
		            console.log("[ì¡°ì§ë„ ë°ì´í„°]", data);
		            buildTree(data);
		        })
		        .catch(error => console.error("ì¡°ì§ë„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
		});
		
		function buildTree(data) {
		    const tree = document.getElementById("orgTree");
		    tree.innerHTML = "";
		
		    const companyMap = {};
		    const deptMap = {};
		
		    // íšŒì‚¬ë³„ë¡œ ë¶€ì„œ ê·¸ë£¹í™” + ë¶€ì„œ Map ì €ì¥
		    data.forEach(item => {
		        if (!companyMap[item.suberNo]) {
		            companyMap[item.suberNo] = {
		                companyName: item.companyName,
		                departments: []
		            };
		        }
		        companyMap[item.suberNo].departments.push(item);
		        deptMap[item.departmentNo] = item;
		    });
		
		    // ê° íšŒì‚¬ë³„ íŠ¸ë¦¬ êµ¬ì„±
		    Object.values(companyMap).forEach(company => {
		        const companyLi = document.createElement("li");
		
		        // 1) íŠ¸ë¦¬ ì˜ì—­ ë¨¼ì € ìƒì„±
		        const deptTree = document.createElement("ul");
		        deptTree.style.display = "none";
		
		        // 2) íšŒì‚¬ ì´ë¦„ê³¼ ë²„íŠ¼ ë„£ê¸°
		        companyLi.innerHTML = `
		            <span class="toggle-icon">â–¶</span>
		            ğŸ“ <strong class="company-name">${company.companyName}</strong>
		            <button class="btn btn-sm btn-outline-secondary ml-2 toggle-all-btn">ì „ì²´ í¼ì¹˜ê¸°</button>
		        `;
		
		        // 3) ìµœìƒìœ„ ë¶€ì„œë§Œ í•„í„°ë§í•´ì„œ íŠ¸ë¦¬ ìƒì„± ì‹œì‘
		        const topLevelDepts = company.departments.filter(dept => {
		            return !company.departments.some(d => d.departmentNo === dept.upperDepNo);
		        });
		
		        topLevelDepts.forEach(dept => {
		            const deptLi = createDeptNode(dept, deptMap);
		            deptTree.appendChild(deptLi);
		        });
		
		        // 4) íŠ¸ë¦¬ ì¶”ê°€
		        companyLi.appendChild(deptTree);
		        tree.appendChild(companyLi);
		
		        // 5) í† ê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ ì „ì²´ ì—´ê¸°/ë‹«ê¸° ë™ì‘
		        const toggleAllBtn = companyLi.querySelector(".toggle-all-btn");
		        toggleAllBtn.addEventListener("click", function () {
		            const isOpen = toggleAllBtn.textContent.includes("ë‹«ê¸°");
		            toggleAll(companyLi, !isOpen); 
		            toggleAllBtn.textContent = isOpen ? "ì „ì²´ í¼ì¹˜ê¸°" : "ì „ì²´ ë‹«ê¸°";
		        });
		
		        // 6) íšŒì‚¬ëª… ì• â–¶ í´ë¦­ ì‹œ 1ë‹¨ê³„ë§Œ ì—´ê¸°/ë‹«ê¸°
		        companyLi.querySelector(".toggle-icon").addEventListener("click", function () {
		            deptTree.style.display = (deptTree.style.display === "none") ? "block" : "none";
		            this.textContent = (deptTree.style.display === "none") ? "â–¶" : "â–¼";
		        });
		    });
		}
		
		// ë¶€ì„œ íŠ¸ë¦¬ êµ¬ì¡° ì¬ê·€ ìƒì„±
		function createDeptNode(dept, deptMap) {
		    const deptLi = document.createElement("li");
		    const empCount = (dept.employees && dept.employees.length) || 0;
		    deptLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong>${dept.departmentName} (${empCount}ëª…)</strong>`;
		
		    const subTree = document.createElement("ul");
		    subTree.style.display = "none";
		
		    // ë¶€ì„œ ë‚´ ì‚¬ì› ëª©ë¡ ì¶œë ¥
		    if (dept.employees) {
		        dept.employees.forEach(emp => {
		            const empLi = document.createElement("li");
		            empLi.innerHTML = `ğŸ™â€â™‚ï¸ <a href="#" onclick="showEmpInfo(
		                '${emp.employeeName}', 
		                '${dept.departmentName}', 
		                '${emp.jobTitleName}', 
		                '${emp.phoneNumber}', 
		                '${emp.profileImageBase64 || ''}'
		            )"> ${emp.employeeName} (${emp.jobTitleName})</a>`;
		            subTree.appendChild(empLi);
		        });
		    }
		
		    // í•˜ìœ„ ë¶€ì„œ íƒìƒ‰
		    Object.values(deptMap).forEach(subDept => {
		        if (Number(subDept.upperDepNo) === Number(dept.departmentNo)) {
		            const subDeptLi = createDeptNode(subDept, deptMap);
		            subTree.appendChild(subDeptLi);
		        }
		    });
		
		    // ë¶€ì„œ í† ê¸€ ë²„íŠ¼
		    deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
		        subTree.style.display = (subTree.style.display === "none") ? "block" : "none";
		        this.textContent = (subTree.style.display === "none") ? "â–¶" : "â–¼";
		    });
		
		    deptLi.appendChild(subTree);
		    return deptLi;
		}
		
		// ì‚¬ì› ì •ë³´ í‘œì‹œ (ì´ë¦„, ë¶€ì„œ, ì§ê¸‰, ì—°ë½ì²˜, ì´ë¯¸ì§€)
		function showEmpInfo(name, dept, title, phone, imgBase64) {
		    document.getElementById("empName").textContent = name;
		    document.getElementById("empDept").textContent = dept;
		    document.getElementById("empTitle").textContent = title;
		    document.getElementById("empPhone").textContent = phone;
		
		    const img = document.getElementById("empImage");
		    if (imgBase64) {
		        img.src = "data:image/png;base64," + imgBase64;
		        img.style.display = "block";
		    } else {
		        img.src = "";
		        img.style.display = "none";
		    }
		}
		
		// ê²€ìƒ‰ ê¸°ëŠ¥
		document.getElementById("searchInput").addEventListener("input", function () {
		    const searchText = this.value.toLowerCase();
		    const allItems = document.querySelectorAll("#orgTree li");
		
		    allItems.forEach(item => {
		        const text = item.textContent.toLowerCase();
		        if (text.includes(searchText)) {
		            item.style.display = "";
		            let parent = item.parentElement;
		            while (parent && parent.id !== "orgTree") {
		                if (parent.tagName === "UL") parent.style.display = "block";
		                if (parent.tagName === "LI") {
		                    const toggle = parent.querySelector(".toggle-icon");
		                    if (toggle) toggle.textContent = "â–¼";
		                }
		                parent = parent.parentElement;
		            }
		        } else {
		            item.style.display = "none";
		        }
		    });
		});
		
		// ì „ì²´ ì—´ê¸°/ë‹«ê¸° í•¨ìˆ˜ (ëª¨ë“  í•˜ìœ„ íŠ¸ë¦¬ í† ê¸€)
		function toggleAll(root, open) {
		    const uls = root.querySelectorAll("ul");
		    const toggles = root.querySelectorAll(".toggle-icon");
		
		    uls.forEach(ul => ul.style.display = open ? "block" : "none");
		    toggles.forEach(icon => icon.textContent = open ? "â–¼" : "â–¶");
		}
</script>

</body>
</html>
