<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>Ï°∞ÏßÅÎèÑ</title>
    <style>
        #orgTree, #orgTree ul {
            list-style: none;
            padding-left: 10px;
        }

        #orgTree li {
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            position: relative;
        }

        .toggle-icon {
            cursor: pointer;
            margin-right: 5px;
        }

        #searchInput {
            font-size: 14px;
            padding: 8px;
        }

        .company-name {
            font-weight: bold;
            font-size: 20px;
            color: #007bff;
            margin-bottom: 10px;
        }

        .fixed-sidebar {
            position: fixed;
            width: 500px;
            z-index: 999;
        }
        /* ÏßÅÏõê Ï†ïÎ≥¥ Ï§Ñ Ï†ïÎ†¨ Ïä§ÌÉÄÏùº */
		.emp-info-group {
		    display: flex;
		    justify-content: center;
		    margin-bottom: 6px;
		}
		
		.emp-info-label {
		    width: 60px;
		    text-align: right;
		    font-weight: bold;
		    margin-right: 8px;
		}
		
		.emp-info-value {
		    text-align: left;
		    min-width: 200px;
		}
    </style>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-4">
    <h2 class="text-center">Ï°∞ÏßÅÎèÑ</h2>

    <div class="row">
        <!-- Ï°∞ÏßÅÎèÑ Ìä∏Î¶¨ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <input type="text" id="searchInput" class="form-control" placeholder="üîç Í≤ÄÏÉâ">
                </div>
                <div class="card-body">
                    <ul id="orgTree" class="list-unstyled"></ul>
                </div>
            </div>
        </div>

		<!-- ÏßÅÏõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
		<div class="col-md-6">
		    <div class="card fixed-sidebar">
		        <div class="card-body text-center">
		            <h5 class="font-weight-bold mb-3">ÏßÅÏõê Ï†ïÎ≥¥</h5>
		            <hr>
		
		            <div class="emp-info-group">
		                <div class="emp-info-label">Ïù¥Î¶Ñ:</div>
		                <div class="emp-info-value" id="empName">-</div>
		            </div>
		            <div class="emp-info-group">
		                <div class="emp-info-label">Î∂ÄÏÑú:</div>
		                <div class="emp-info-value" id="empDept">-</div>
		            </div>
		            <div class="emp-info-group">
		                <div class="emp-info-label">ÏßÅÍ∏â:</div>
		                <div class="emp-info-value" id="empTitle">-</div>
		            </div>
		            <div class="emp-info-group">
		                <div class="emp-info-label">Ïó∞ÎùΩÏ≤ò:</div>
		                <div class="emp-info-value" id="empPhone">-</div>
		            </div>
		        </div>
		    </div>
		</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/orgchart")
            .then(response => response.json())
            .then(data => {
                console.log("[Ï°∞ÏßÅÎèÑ Îç∞Ïù¥ÌÑ∞]", data);
                buildTree(data);
            })
            .catch(error => console.error("Ï°∞ÏßÅÎèÑ Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", error));
    });

    function buildTree(data) {
        const tree = document.getElementById("orgTree");
        tree.innerHTML = "";

        const companyMap = {};
        const deptMap = {};

        // ÌöåÏÇ¨Î≥ÑÎ°ú Î∂ÄÏÑú ÎÇòÎàÑÍ∏∞ + Î∂ÄÏÑú Map Ï†ÄÏû•
        data.forEach(item => {
            if (!companyMap[item.suberNo]) {
                companyMap[item.suberNo] = {
                    companyName: item.companyName,
                    departments: []
                };
            }
            companyMap[item.suberNo].departments.push(item);
            deptMap[item.departmentNo] = item;
        });

        // ÌöåÏÇ¨Î≥Ñ Ìä∏Î¶¨ ÏÉùÏÑ±
        Object.values(companyMap).forEach(company => {
            const companyLi = document.createElement("li");
            companyLi.innerHTML = `<span class="toggle-icon">‚ñ∂</span> üìÅ <strong class="company-name">${company.companyName}</strong>`;

            const deptTree = document.createElement("ul");
            deptTree.style.display = "none";

            //  ÏµúÏÉÅÏúÑ Î∂ÄÏÑú Ï∞æÍ∏∞ (upperDepNoÍ∞Ä ÌòÑÏû¨ ÌöåÏÇ¨Ïùò Î∂ÄÏÑú Î™©Î°ùÏóê Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞)
            const topLevelDepts = company.departments.filter(dept => {
                return !company.departments.some(d => d.departmentNo === dept.upperDepNo);
            });

            // ÏµúÏÉÅÏúÑ Î∂ÄÏÑúÎ∂ÄÌÑ∞ Ìä∏Î¶¨ ÏÉùÏÑ±
            topLevelDepts.forEach(dept => {
                const deptLi = createDeptNode(dept, deptMap);
                deptTree.appendChild(deptLi);
            });

            companyLi.appendChild(deptTree);
            tree.appendChild(companyLi);

            // Ìä∏Î¶¨ ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞
            companyLi.querySelector(".toggle-icon").addEventListener("click", function () {
                deptTree.style.display = (deptTree.style.display === "none") ? "block" : "none";
                this.textContent = (deptTree.style.display === "none") ? "‚ñ∂" : "‚ñº";
            });
        });
    }

    function createDeptNode(dept, deptMap) {
        const deptLi = document.createElement("li");
        const empCount = (dept.employees && dept.employees.length) || 0;
        deptLi.innerHTML = `<span class="toggle-icon">‚ñ∂</span> üìÅ <strong>${dept.departmentName} (${empCount}Î™Ö)</strong>`;

        const subTree = document.createElement("ul");
        subTree.style.display = "none";

        if (dept.employees) {
            dept.employees.forEach(emp => {
                const empLi = document.createElement("li");
                empLi.innerHTML = `üôç‚Äç‚ôÇÔ∏è <a href="#" onclick="showEmpInfo('${emp.employeeName}', '${dept.departmentName}', '${emp.jobTitleName}', '${emp.phoneNumber}')">${emp.employeeName} (${emp.jobTitleName})</a>`;
                subTree.appendChild(empLi);
            });
        }

        // ÌïòÏúÑ Î∂ÄÏÑú ÌÉêÏÉâ (upperDepNo ‚Üí departmentNo)
        Object.values(deptMap).forEach(subDept => {
            if (Number(subDept.upperDepNo) === Number(dept.departmentNo)) {
                const subDeptLi = createDeptNode(subDept, deptMap);
                subTree.appendChild(subDeptLi);
            }
        });

        deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
            subTree.style.display = (subTree.style.display === "none") ? "block" : "none";
            this.textContent = (subTree.style.display === "none") ? "‚ñ∂" : "‚ñº";
        });

        deptLi.appendChild(subTree);
        return deptLi;
    }

    function showEmpInfo(name, dept, title, phone) {
        document.getElementById("empName").textContent = name;
        document.getElementById("empDept").textContent = dept;
        document.getElementById("empTitle").textContent = title;
        document.getElementById("empPhone").textContent = phone;
    }

    // Í≤ÄÏÉâ Í∏∞Îä•
    document.getElementById("searchInput").addEventListener("input", function () {
        const searchText = this.value.toLowerCase();
        const allItems = document.querySelectorAll("#orgTree li");

        allItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchText)) {
                item.style.display = "";
                let parent = item.parentElement;
                while (parent && parent.id !== "orgTree") {
                    if (parent.tagName === "UL") parent.style.display = "block";
                    if (parent.tagName === "LI") {
                        const toggle = parent.querySelector(".toggle-icon");
                        if (toggle) toggle.textContent = "‚ñº";
                    }
                    parent = parent.parentElement;
                }
            } else {
                item.style.display = "none";
            }
        });
    });
</script>

</body>
</html>
