<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ì¡°ì§ë„</title>
    <style>
        /* ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì œê±° */
        #orgTree, #orgTree ul {
            list-style: none;
            padding-left: 10px;
        }

        #orgTree li {
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            position: relative;
        }

        /* í¼ì¹˜ê¸°/ì ‘ê¸° ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .toggle-icon {
            cursor: pointer;
            margin-right: 5px;
        }

        /* ê²€ìƒ‰ì°½ */
        #searchInput {
            font-size: 14px;
            padding: 8px;
        }

        /* íšŒì‚¬ëª… ê°•ì¡° */
        .company-name {
            font-weight: bold;
            font-size: 20px;
            color: #007bff;
            margin-bottom: 10px;
        }

        /* ì˜¤ë¥¸ìª½ ì§ì› ì •ë³´ ì¹´ë“œ */
        .fixed-sidebar {
            position: fixed;
            width: 500px;
            z-index: 999;
        }
    </style>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-4">
    <h2 class="text-center">ì¡°ì§ë„</h2>

    <div class="row">
        <!-- ì¡°ì§ë„ íŠ¸ë¦¬ ì˜ì—­ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” ê²€ìƒ‰">
                </div>
                <div class="card-body">
                    <ul id="orgTree" class="list-unstyled"></ul>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ì§ì› ìƒì„¸ ì •ë³´ -->
        <div class="col-md-6">
            <div class="card fixed-sidebar">
                <div class="card-body text-center">
                    <h5>ì§ì› ì •ë³´</h5>
                    <hr>
                    <p><strong>ì´ë¦„:</strong> <span id="empName">-</span></p>
                    <p><strong>ë¶€ì„œ:</strong> <span id="empDept">-</span></p>
                    <p><strong>ì§ê¸‰:</strong> <span id="empTitle">-</span></p>
                    <p><strong>ì—°ë½ì²˜:</strong> <span id="empPhone">-</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // í˜ì´ì§€ ë¡œë”© ì‹œ API í˜¸ì¶œ
    document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/orgchart")
            .then(response => response.json())
            .then(data => {
                console.log("[ì¡°ì§ë„ ë°ì´í„°]", data);  // â† ë¬¸ì œ ë””ë²„ê¹…ìš© ë¡œê·¸
                buildTree(data);
            })
            .catch(error => console.error("ì¡°ì§ë„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
    });

    // ì¡°ì§ë„ íŠ¸ë¦¬ ìƒì„± í•¨ìˆ˜
    function buildTree(data) {
        const tree = document.getElementById("orgTree");
        tree.innerHTML = "";

        const companyMap = {}; // íšŒì‚¬ë³„ë¡œ ë¬¶ê¸°
        const deptMap = {};    // ë¶€ì„œë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ë¬¶ê¸°

        // íšŒì‚¬ë³„ ê·¸ë£¹í™”
        data.forEach(item => {
            if (!companyMap[item.suberNo]) {
                companyMap[item.suberNo] = {
                    companyName: item.companyName,
                    departments: []
                };
            }
            companyMap[item.suberNo].departments.push(item);
        });

        // íšŒì‚¬ ê¸°ì¤€ íŠ¸ë¦¬ ìƒì„±
        Object.values(companyMap).forEach(company => {
            const companyLi = document.createElement("li");
            companyLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong class="company-name">${company.companyName}</strong>`;

            const deptTree = document.createElement("ul");
            deptTree.style.display = "none";

            // ë¶€ì„œ ì •ë¦¬ (ìƒìœ„ ë¶€ì„œ nullì´ë©´ ìµœìƒìœ„)
            const topLevelDepts = [];
            company.departments.forEach(dept => {
                if (!dept.upperDepNo) {
                    topLevelDepts.push(dept);
                }
                deptMap[dept.departmentNo] = dept;
            });

            // ìµœìƒìœ„ ë¶€ì„œ íŠ¸ë¦¬ ìƒì„±
            topLevelDepts.forEach(dept => {
                const deptLi = createDeptNode(dept, deptMap);
                deptTree.appendChild(deptLi);
            });

            companyLi.appendChild(deptTree);
            tree.appendChild(companyLi);

            // í´ë¦­ ì‹œ íŠ¸ë¦¬ ì—´ê¸°/ë‹«ê¸°
            companyLi.querySelector(".toggle-icon").addEventListener("click", function () {
                deptTree.style.display = (deptTree.style.display === "none") ? "block" : "none";
                this.textContent = (deptTree.style.display === "none") ? "â–¶" : "â–¼";
            });
        });
    }

    // ë¶€ì„œ ë…¸ë“œ ìƒì„± (ì¬ê·€)
    function createDeptNode(dept, deptMap) {
        const deptLi = document.createElement("li");
        const empCount = (dept.employees && dept.employees.length) || 0;
        deptLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong>${dept.departmentName} (${empCount}ëª…)</strong>`;

        const subTree = document.createElement("ul");
        subTree.style.display = "none";

        // ì§ì› ëª©ë¡ ì¶œë ¥
        if (dept.employees) {
            dept.employees.forEach(emp => {
                const empLi = document.createElement("li");
                empLi.innerHTML = `ğŸ™â€â™‚ï¸ <a href="#" onclick="showEmpInfo('${emp.employeeName}', '${dept.departmentName}', '${emp.jobTitleName}', '${emp.phoneNumber}')">${emp.employeeName} (${emp.jobTitleName})</a>`;
                subTree.appendChild(empLi);
            });
        }

        // í•˜ìœ„ ë¶€ì„œ ì¬ê·€ í˜¸ì¶œ
        Object.values(deptMap).forEach(subDept => {
            if (subDept.upperDepNo === dept.departmentNo) {
                const subDeptLi = createDeptNode(subDept, deptMap);
                subTree.appendChild(subDeptLi);
            }
        });

        // í¼ì¹˜ê¸° ê¸°ëŠ¥
        deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
            subTree.style.display = (subTree.style.display === "none") ? "block" : "none";
            this.textContent = (subTree.style.display === "none") ? "â–¶" : "â–¼";
        });

        deptLi.appendChild(subTree);
        return deptLi;
    }

    // ì˜¤ë¥¸ìª½ ì§ì› ì •ë³´ í‘œì‹œ
    function showEmpInfo(name, dept, title, phone) {
        document.getElementById("empName").textContent = name;
        document.getElementById("empDept").textContent = dept;
        document.getElementById("empTitle").textContent = title;
        document.getElementById("empPhone").textContent = phone;
    }

    // ê²€ìƒ‰ ê¸°ëŠ¥ (íŠ¸ë¦¬ ìë™ í¼ì¹¨)
    document.getElementById("searchInput").addEventListener("input", function () {
        const searchText = this.value.toLowerCase();
        const allItems = document.querySelectorAll("#orgTree li");

        allItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchText)) {
                item.style.display = "";
                let parent = item.parentElement;
                while (parent && parent.id !== "orgTree") {
                    if (parent.tagName === "UL") parent.style.display = "block";
                    if (parent.tagName === "LI") {
                        const toggle = parent.querySelector(".toggle-icon");
                        if (toggle) toggle.textContent = "â–¼";
                    }
                    parent = parent.parentElement;
                }
            } else {
                item.style.display = "none";
            }
        });
    });
</script>

</body>
</html>
