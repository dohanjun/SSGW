<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ì¡°ì§ë„</title>
    <style>
		/* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì œê±° */
		#orgTree, #orgTree ul {
		    list-style: none;
		    padding-left: 10px;
		}
		
		#orgTree li {
		    cursor: pointer;
		    padding: 5px;
		    font-size: 16px;
		    position: relative;
		}
		
		/* ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ */
		.toggle-icon {
		    cursor: pointer;
		    margin-right: 5px;
		}
		
		/* ì§ì› í”„ë¡œí•„ ìŠ¤íƒ€ì¼ */
		.profile-img {
		    width: 100px;
		    height: 100px;
		    border-radius: 50%;
		    object-fit: cover;
		}
		
		/* ê²€ìƒ‰ ì…ë ¥ì°½ */
		#searchInput {
		    font-size: 14px;
		    padding: 8px;
		}
		
		/* ìµœìƒìœ„ íšŒì‚¬ëª… ìŠ¤íƒ€ì¼ */
		.company-name {
		    font-weight: bold;
		    font-size: 20px;
		    color: #007bff;
		    margin-bottom: 10px;
		}
		
		/* í™”ë©´ ë”°ë¼ì˜¤ëŠ” ìŠ¤íƒ€ì¼ */
		.fixed-sidebar {
		    position: fixed;
		    width: 500px;
		    z-index: 999;
		}
		
		

    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/orgChart.css">
</head>
<body>

<div class="container mt-4">
    <h2 class="text-center">ì¡°ì§ë„</h2>

    <div class="row">
        <!-- ì¡°ì§ë„ íŠ¸ë¦¬ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <input type="text" id="searchInput" class="form-control" placeholder="ğŸ” ê²€ìƒ‰">
                </div>
                <div class="card-body">
                    <ul id="orgTree" class="list-unstyled"></ul>
                </div>
            </div>
        </div>

        <!-- ì§ì› ìƒì„¸ ì •ë³´ -->
		<div class="col-md-6">
		    <div class="card fixed-sidebar">
		        <div class="card-body text-center">
		            <h5>ì§ì› ì •ë³´</h5>
		            <img id="empImage" class="profile-img"
		                 th:if="${profileImageBase64}"
		                 th:src="'data:image/png;base64,' + ${profileImageBase64}"
		                 alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
                    <hr>
                    <p><strong>ì´ë¦„:</strong> <span id="empName">-</span></p>
                    <p><strong>ë¶€ì„œ:</strong> <span id="empDept">-</span></p>
                    <p><strong>ì§ê¸‰:</strong> <span id="empTitle">-</span></p>
                    <p><strong>ì—°ë½ì²˜:</strong> <span id="empPhone">-</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

		// ì¡°ì§ë„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
		document.addEventListener("DOMContentLoaded", function () {
		    fetch("/api/orgchart")
		        .then(response => response.json())
		        .then(data => buildTree(data))
		        .catch(error => console.error("ì¡°ì§ë„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
		});
		
		function buildTree(data) {
		    let tree = document.getElementById("orgTree");
		    tree.innerHTML = "";
		
		    let companyMap = {}; // íšŒì‚¬ë³„ë¡œ ê·¸ë£¹í™”
		    let deptMap = {}; // ë¶€ì„œë³„ë¡œ ê·¸ë£¹í™”
		
		    // íšŒì‚¬ë³„ ë°ì´í„° ë¶„ë¥˜
		    data.forEach(item => {
		        if (!companyMap[item.suberNo]) {
		            companyMap[item.suberNo] = {
		                companyName: item.companyName,
		                departments: []
		            };
		        }
		        companyMap[item.suberNo].departments.push(item);
		    });
		
		    // íšŒì‚¬ë³„ ìµœìƒìœ„ ë…¸ë“œ ìƒì„±
		    Object.values(companyMap).forEach(company => {
		        let companyLi = document.createElement("li");
		        companyLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong class="company-name">${company.companyName}</strong>`;
		
		        let deptTree = document.createElement("ul");
		        deptTree.style.display = "none";
		
		        // ë¶€ì„œë³„ë¡œ ê·¸ë£¹í™”
		        let topLevelDepts = [];
		        company.departments.forEach(dept => {
		            if (!dept.upperDepNo) {
		                topLevelDepts.push(dept);
		            } else {
		                deptMap[dept.departmentNo] = dept;
		            }
		        });
		
		        // ëŒ€í‘œ ë¶€ì„œ ë¨¼ì € ì¶œë ¥
		        topLevelDepts.forEach(dept => {
		            let deptLi = createDeptNode(dept, deptMap);
		            deptTree.appendChild(deptLi);
		        });
		
		        companyLi.appendChild(deptTree);
		        tree.appendChild(companyLi);
		
		        // íšŒì‚¬ëª… í´ë¦­ ì‹œ í¼ì¹˜ê¸°/ì ‘ê¸°
		        companyLi.querySelector(".toggle-icon").addEventListener("click", function () {
		            if (deptTree.style.display === "none") {
		                deptTree.style.display = "block";
		                this.textContent = "â–¼";
		            } else {
		                deptTree.style.display = "none";
		                this.textContent = "â–¶";
		            }
		        });
		    });
		}
		
		// ë¶€ì„œ ë…¸ë“œ ìƒì„± í•¨ìˆ˜
		function createDeptNode(dept, deptMap) {
		    let deptLi = document.createElement("li");
		    deptLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong>${dept.departmentName} (${dept.employees.length}ëª…)</strong>`;
		
		    let subTree = document.createElement("ul");
		    subTree.style.display = "none"; // ì²˜ìŒì—” ì ‘ê¸°
		
		    // ì§ì› ëª©ë¡ ì¶”ê°€
		    dept.employees.forEach(emp => {
		        let empLi = document.createElement("li");
		        empLi.innerHTML = `ğŸ™â€â™‚ï¸ <a href="#" onclick="showEmpInfo('${emp.employeeName}', '${dept.departmentName}', '${emp.jobTitleName}', '${emp.phoneNumber}', '${emp.profileImage}')">${emp.employeeName} (${emp.jobTitleName})</a>`;
		        subTree.appendChild(empLi);
		    });
		
		    // í•˜ìœ„ ë¶€ì„œ ì¶”ê°€
		    Object.values(deptMap).forEach(subDept => {
		        if (subDept.upperDepNo === dept.departmentNo) {
		            let subDeptLi = createDeptNode(subDept, deptMap);
		            subTree.appendChild(subDeptLi);
		        }
		    });
		
		    // í´ë¦­í•˜ë©´ í¼ì¹˜ê¸°/ì ‘ê¸°
		    deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
		        if (subTree.style.display === "none") {
		            subTree.style.display = "block";
		            this.textContent = "â–¼";
		        } else {
		            subTree.style.display = "none";
		            this.textContent = "â–¶";
		        }
		    });
		
		    deptLi.appendChild(subTree);
		    return deptLi;
		}
		
		// ì§ì› ì •ë³´ í‘œì‹œ í•¨ìˆ˜
		function showEmpInfo(name, dept, title, phone, image) {
		    document.getElementById("empName").textContent = name;
		    document.getElementById("empDept").textContent = dept;
		    document.getElementById("empTitle").textContent = title;
		    document.getElementById("empPhone").textContent = phone;
		    document.getElementById("empImage").src = image ? image : "/img/default-profile.png";
		}
		
		// ê²€ìƒ‰ ê¸°ëŠ¥ - ë¶€ëª¨ íŠ¸ë¦¬ ìë™ í¼ì¹¨
	    document.getElementById("searchInput").addEventListener("input", function () {
	        let searchText = this.value.toLowerCase();
	        let allItems = document.querySelectorAll("#orgTree li");
	
	        allItems.forEach(item => {
	            let text = item.textContent.toLowerCase();
	            if (text.includes(searchText)) {
	                item.style.display = "";
	
	                // ë¶€ëª¨ ul/li íŠ¸ë¦¬ ëª¨ë‘ í¼ì¹˜ê¸°
	                let parent = item.parentElement;
	                while (parent && parent.id !== "orgTree") {
	                    if (parent.tagName === "UL") {
	                        parent.style.display = "block";
	                    }
	                    if (parent.tagName === "LI") {
	                        let toggle = parent.querySelector(".toggle-icon");
	                        if (toggle) toggle.textContent = "â–¼";
	                    }
	                    parent = parent.parentElement;
	                }
	
	            } else {
	                item.style.display = "none";
	            }
	        });
	    });

</script>

</body>
</html>
