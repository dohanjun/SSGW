<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">

<head>
    <meta charset="UTF-8">
    <title>ë¶€ì„œ ê´€ë¦¬</title>

    <!-- CSRF í† í° -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
    <style>
        .card-box {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #fff;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #333;
            text-align: center;
        }

        .section-box {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            background-color: #fafafa;
            margin-bottom: 20px;
        }

        .dept-info {
            display: flex;
            align-items: center;
            padding: 2px 0;
        }

        .dept-name-fixed {
            width: 130px;
            font-weight: bold;
            font-size: 14px;
            line-height: 1.2;
            margin: 0;
        }

        .manager-name {
            font-size: 13.3px;
            line-height: 1.2;
            margin: 0;
            padding: 0;
        }

        .list-group-item {
            padding-top: 6px;
            padding-bottom: 6px;
            cursor: pointer;
        }

        .btn-delete-custom {
            background-color: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            transition: all 0.2s;
        }

        .btn-delete-custom:hover {
            background-color: #dc3545;
            color: #fff;
        }
    </style>
</head>

<body>
<div class="container mt-4">
    <div class="card-box">
        <div class="card-title">ë¶€ì„œ ê´€ë¦¬</div>
        <div class="row">
            <!-- ì™¼ìª½: ë¶€ì„œ ë“±ë¡ -->
            <div class="col-md-6">
                <div class="section-box">
                    <h5 class="text-center mb-3">ë¶€ì„œ ë“±ë¡</h5>
                    <form th:action="@{/deptInsert}" th:object="${deptVO}" method="post" onsubmit="return confirmInsert()">
                        <input type="hidden" th:field="*{departmentNo}" />
                        <input type="hidden" th:field="*{suberNo}" />

                        <div class="form-group">
                            <label>ë¶€ì„œëª…</label>
                            <input type="text" class="form-control" th:field="*{departmentName}" required>
                        </div>

                        <div class="form-group">
                            <label>ìƒìœ„ ë¶€ì„œ</label>
							<select class="form-control text-monospace" th:field="*{upperDepNo}" style="font-family: monospace;">
							  <option value="0">-- ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
							  <option th:each="dept : ${deptList}"
							          th:value="${dept.departmentNo}"
							          th:text="${#strings.concat(#strings.repeat(' ', 12 - dept.departmentName.length()), dept.departmentName, '  (Lv.', dept.departmentLevel != null ? dept.departmentLevel : 0, ')')}">
							  </option>
							</select>
                        </div>

                        <div class="d-flex justify-content-center mt-4">
                            <button type="submit" class="btn btn-success mx-2 px-4">ë“±ë¡</button>
                            <button type="button" class="btn btn-danger mx-2 px-4" th:onclick="|location.href='@{/deptMgmt}'|">ë’¤ë¡œ</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë¶€ì„œì¥ ì¶”ê°€ -->
            <div class="col-md-6">
                <div class="section-box">
                    <h5 class="text-center mb-3">ë¶€ì„œì¥ ì¶”ê°€</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex align-items-center justify-content-between"
                            th:each="dept : ${deptList}"
                            th:onclick="|openOrgModal(${dept.departmentNo})|">
                            
                            <!-- ë¶€ì„œëª… + ë¶€ì„œì¥ -->
                            <div class="dept-info">
                                <div class="dept-name-fixed" th:text="${dept.departmentName}"></div>
                                <span th:if="${dept.employeeName != null}"
                                      th:text="'ë¶€ì„œì¥ : ' + ${dept.employeeName}"
                                      class="text-success small manager-name"></span>
                                <span th:if="${dept.employeeName == null}"
                                      class="text-danger small manager-name">(ë¶€ì„œì¥ ë¯¸ì§€ì •)</span>
                            </div>

                            <!-- ì‚­ì œ ë²„íŠ¼: í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ -->
                            <button type="button" class="btn btn-sm btn-delete-custom"
                                    th:onclick="|event.stopPropagation(); deleteDepartment(${dept.departmentNo})|">
                                ì‚­ì œ
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¡°ì§ë„ ëª¨ë‹¬ -->
<div class="modal fade" id="orgModal" tabindex="-1" role="dialog" aria-labelledby="orgModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì¡°ì§ë„ì—ì„œ ë¶€ì„œì¥ ì„ íƒ</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchInput" class="form-control mb-3" placeholder="ğŸ” ì‚¬ì›ëª… ê²€ìƒ‰">
                <div class="row">
                    <div class="col-md-6"><ul id="orgTree" class="list-unstyled"></ul></div>
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>ì§ì› ì •ë³´</h5><hr>
                                <p><strong>ì´ë¦„:</strong> <span id="empName">-</span></p>
                                <p><strong>ë¶€ì„œ:</strong> <span id="empDept">-</span></p>
                                <p><strong>ì§ê¸‰:</strong> <span id="empTitle">-</span></p>
                                <p><strong>ì—°ë½ì²˜:</strong> <span id="empPhone">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--  JavaScript (with ì„¤ëª… ì£¼ì„) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    let selectedDeptNo = null;

    // CSRF ì„¤ì •
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    // ë¶€ì„œ ë“±ë¡ ì‹œ ì•Œë¦¼
    function confirmInsert() {
        alert("ë¶€ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        return true;
    }

    // ë¶€ì„œ í´ë¦­ ì‹œ ì¡°ì§ë„ ëª¨ë‹¬ ì—´ê¸°
    function openOrgModal(deptNo) {
        selectedDeptNo = deptNo;
        fetch("/api/orgchart")
            .then(res => res.json())
            .then(data => {
                buildTree(data);
                $('#orgModal').modal('show');
            });
    }

    // ì¡°ì§ë„ íŠ¸ë¦¬ ìƒì„±
    function buildTree(data) {
        const tree = document.getElementById("orgTree");
        tree.innerHTML = "";

        const deptMap = {}, companyMap = {};

        // ë¶€ì„œ, íšŒì‚¬ ì •ë³´ ì •ë¦¬
        data.forEach(item => {
            if (!companyMap[item.suberNo]) {
                companyMap[item.suberNo] = { companyName: item.companyName, departments: [] };
            }
            companyMap[item.suberNo].departments.push(item);
            deptMap[item.departmentNo] = item;
        });

        // íšŒì‚¬ë³„ íŠ¸ë¦¬ êµ¬ì„±
        Object.values(companyMap).forEach(company => {
            const companyLi = document.createElement("li");
            companyLi.innerHTML = `<span class="toggle-icon">â–¶</span> <strong style="color:blue">${company.companyName}</strong>`;
            const deptTree = document.createElement("ul");
            deptTree.style.display = "none";

            const topDepts = company.departments.filter(d => !company.departments.some(sub => sub.departmentNo === d.upperDepNo));
            topDepts.forEach(dept => deptTree.appendChild(createDeptNode(dept, deptMap)));

            companyLi.appendChild(deptTree);
            tree.appendChild(companyLi);

            // í¼ì¹˜ê¸° ë²„íŠ¼
            companyLi.querySelector(".toggle-icon").addEventListener("click", function () {
                deptTree.style.display = deptTree.style.display === "none" ? "block" : "none";
                this.textContent = deptTree.style.display === "none" ? "â–¶" : "â–¼";
            });
        });
    }

    // ë¶€ì„œ ë…¸ë“œ ìƒì„±
    function createDeptNode(dept, deptMap) {
        const li = document.createElement("li");
        const subTree = document.createElement("ul");
        subTree.style.display = "none";

        const empList = (dept.employees || []).map(emp => `
            <li>
                ğŸ™â€â™‚ï¸ <a href="#" onclick="
                    showEmpInfo('${emp.employeeName}', '${dept.departmentName}', '${emp.jobTitleName}', '${emp.phoneNumber}');
                    selectManager(${emp.employeeNo});
                ">${emp.employeeName} (${emp.jobTitleName})</a>
            </li>`).join('');

        li.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong>${dept.departmentName}</strong><ul>${empList}</ul>`;

        // í•˜ìœ„ ë¶€ì„œ ì—°ê²°
        (Object.values(deptMap).filter(d => d.upperDepNo === dept.departmentNo) || [])
            .forEach(sub => subTree.appendChild(createDeptNode(sub, deptMap)));

        li.querySelector("ul").appendChild(subTree);

        // íŠ¸ë¦¬ í¼ì¹˜ê¸° ì´ë²¤íŠ¸
        li.querySelector(".toggle-icon").addEventListener("click", function () {
            subTree.style.display = subTree.style.display === "none" ? "block" : "none";
            this.textContent = subTree.style.display === "none" ? "â–¶" : "â–¼";
        });

        return li;
    }

    // ì˜¤ë¥¸ìª½ ì •ë³´ ì¹´ë“œì— ì„ íƒí•œ ì‚¬ì› í‘œì‹œ
    function showEmpInfo(name, dept, title, phone) {
        document.getElementById("empName").textContent = name;
        document.getElementById("empDept").textContent = dept;
        document.getElementById("empTitle").textContent = title;
        document.getElementById("empPhone").textContent = phone;
    }

    // ë¶€ì„œì¥ ì§€ì •
    function selectManager(employeeNo) {
        if (!selectedDeptNo) return;
        if (!confirm("ì´ ì‚¬ì›ì„ ë¶€ì„œì¥ìœ¼ë¡œ ì§€ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const params = new URLSearchParams();
        params.append("employeeNo", employeeNo);
        params.append("departmentNo", selectedDeptNo);

        fetch("/updateManager", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [csrfHeader]: csrfToken
            },
            body: params
        })
        .then(res => res.text())
        .then(result => {
            if (result === "success") {
                alert("ë¶€ì„œì¥ì´ ì§€ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } else {
                alert("ì§€ì • ì‹¤íŒ¨!");
            }
        })
        .catch(err => {
            alert("ì˜¤ë¥˜ ë°œìƒ!");
            console.error(err);
        });
    }

    // ì¡°ì§ë„ ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById("searchInput").addEventListener("input", function () {
        const searchText = this.value.toLowerCase();
        const items = document.querySelectorAll("#orgTree li");
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchText)) {
                item.style.display = "";
                let parent = item.parentElement;
                while (parent && parent.id !== "orgTree") {
                    if (parent.tagName === "UL") parent.style.display = "block";
                    if (parent.tagName === "LI") {
                        const toggle = parent.querySelector(".toggle-icon");
                        if (toggle) toggle.textContent = "â–¼";
                    }
                    parent = parent.parentElement;
                }
            } else {
                item.style.display = "none";
            }
        });
    });
    
 // ë¶€ì„œ ì‚­ì œ ìš”ì²­
    function deleteDepartment(departmentNo) {
        if (!confirm("ì •ë§ë¡œ ì´ ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("/deleteDepartment", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [csrfHeader]: csrfToken
            },
            body: "departmentNo=" + departmentNo
        })
        .then(res => res.text())
        .then(result => {
            if (result === "hasChild") {
                alert("âŒ í•˜ìœ„ ë¶€ì„œê°€ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            } else if (result === "hasEmployee") {
                alert("âŒ ì†Œì†ëœ ì‚¬ì›ì´ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            } else if (result === "success") {
                alert("âœ… ë¶€ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } else {
                alert("âš ï¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        })
        .catch(err => {
            alert("ğŸš¨ ì˜¤ë¥˜ ë°œìƒ");
            console.error(err);
        });
    }

</script>

</body>
</html>
