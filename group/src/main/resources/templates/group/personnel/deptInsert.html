<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">

<head>
    <meta charset="UTF-8">
    <title>Î∂ÄÏÑú Í¥ÄÎ¶¨</title>

    <!-- CSRF ÌÜ†ÌÅ∞ -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
    <style>
        .card-box {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #fff;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #333;
            text-align: center;
        }

        .section-box {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            background-color: #fafafa;
            margin-bottom: 20px;
        }

        .dept-info {
            display: flex;
            align-items: center;
            padding: 2px 0;
        }

        .dept-name-fixed {
            width: 130px;
            font-weight: bold;
            font-size: 14px;
            line-height: 1.2;
            margin: 0;
        }

        .manager-name {
            font-size: 13.3px;
            line-height: 1.2;
            margin: 0;
            padding: 0;
        }

        .list-group-item {
            padding-top: 6px;
            padding-bottom: 6px;
            cursor: pointer;
        }

        .btn-delete-custom {
            background-color: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            transition: all 0.2s;
        }

        .btn-delete-custom:hover {
            background-color: #dc3545;
            color: #fff;
        }
    </style>
</head>

<body>
<div class="container mt-4">
    <div class="card-box">
        <div class="card-title">Î∂ÄÏÑú Í¥ÄÎ¶¨</div>
        <div class="row">
            <!-- ÏôºÏ™Ω: Î∂ÄÏÑú Îì±Î°ù -->
            <div class="col-md-6">
                <div class="section-box">
                    <h5 class="text-center mb-3">Î∂ÄÏÑú Îì±Î°ù</h5>
                    <form th:action="@{/deptInsert}" th:object="${deptVO}" method="post" onsubmit="return confirmInsert()">
                        <input type="hidden" th:field="*{departmentNo}" />
                        <input type="hidden" th:field="*{suberNo}" />

                        <div class="form-group">
                            <label>Î∂ÄÏÑúÎ™Ö</label>
                            <input type="text" class="form-control" th:field="*{departmentName}" required>
                        </div>

                        <div class="form-group">
                            <label>ÏÉÅÏúÑ Î∂ÄÏÑú</label>
							<select class="form-control text-monospace" th:field="*{upperDepNo}" style="font-family: monospace;">
							  <option value="0">-- Î∂ÄÏÑúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî --</option>
							  <option th:each="dept : ${deptList}"
							          th:value="${dept.departmentNo}"
							          th:text="${#strings.concat(#strings.repeat(' ', 12 - dept.departmentName.length()), dept.departmentName, '  (Lv.', dept.departmentLevel != null ? dept.departmentLevel : 0, ')')}">
							  </option>
							</select>
                        </div>

                        <div class="d-flex justify-content-center mt-4">
                            <button type="submit" class="btn btn-success mx-2 px-4">Îì±Î°ù</button>
                            <button type="button" class="btn btn-danger mx-2 px-4" th:onclick="|location.href='@{/deptMgmt}'|">Îí§Î°ú</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Ïò§Î•∏Ï™Ω: Î∂ÄÏÑúÏû• Ï∂îÍ∞Ä -->
            <div class="col-md-6">
                <div class="section-box">
                    <h5 class="text-center mb-3">Î∂ÄÏÑúÏû• Ï∂îÍ∞Ä</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex align-items-center justify-content-between"
                            th:each="dept : ${deptList}"
                            th:onclick="|openOrgModal(${dept.departmentNo})|">
                            
                            <!-- Î∂ÄÏÑúÎ™Ö + Î∂ÄÏÑúÏû• -->
                            <div class="dept-info">
                                <div class="dept-name-fixed" th:text="${dept.departmentName}"></div>
                                <span th:if="${dept.employeeName != null}"
                                      th:text="'Î∂ÄÏÑúÏû• : ' + ${dept.employeeName}"
                                      class="text-success small manager-name"></span>
                                <span th:if="${dept.employeeName == null}"
                                      class="text-danger small manager-name">(Î∂ÄÏÑúÏû• ÎØ∏ÏßÄÏ†ï)</span>
                            </div>

                            <!-- ÏÇ≠Ï†ú Î≤ÑÌäº: ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ -->
                            <button type="button" class="btn btn-sm btn-delete-custom"
                                    th:onclick="|event.stopPropagation(); deleteDepartment(${dept.departmentNo})|">
                                ÏÇ≠Ï†ú
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ï°∞ÏßÅÎèÑ Î™®Îã¨ -->
<div class="modal fade" id="orgModal" tabindex="-1" role="dialog" aria-labelledby="orgModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ï°∞ÏßÅÎèÑÏóêÏÑú Î∂ÄÏÑúÏû• ÏÑ†ÌÉù</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchInput" class="form-control mb-3" placeholder="üîç ÏÇ¨ÏõêÎ™Ö Í≤ÄÏÉâ">
                <div class="row">
                    <div class="col-md-6"><ul id="orgTree" class="list-unstyled"></ul></div>
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>ÏßÅÏõê Ï†ïÎ≥¥</h5><hr>
                                <p><strong>Ïù¥Î¶Ñ:</strong> <span id="empName">-</span></p>
                                <p><strong>Î∂ÄÏÑú:</strong> <span id="empDept">-</span></p>
                                <p><strong>ÏßÅÍ∏â:</strong> <span id="empTitle">-</span></p>
                                <p><strong>Ïó∞ÎùΩÏ≤ò:</strong> <span id="empPhone">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--  JavaScript (with ÏÑ§Î™Ö Ï£ºÏÑù) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    let selectedDeptNo = null;

    // CSRF ÏÑ§Ï†ï
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    // Î∂ÄÏÑú Îì±Î°ù Ïãú ÏïåÎ¶º
    function confirmInsert() {
        alert("Î∂ÄÏÑúÍ∞Ä Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
        return true;
    }

    // Î∂ÄÏÑú ÌÅ¥Î¶≠ Ïãú Ï°∞ÏßÅÎèÑ Î™®Îã¨ Ïó¥Í∏∞
    function openOrgModal(deptNo) {
        selectedDeptNo = deptNo;
        fetch("/api/orgchart")
            .then(res => res.json())
            .then(data => {
                buildTree(data);
                $('#orgModal').modal('show');
            });
    }

    // Ï°∞ÏßÅÎèÑ Ìä∏Î¶¨ ÏÉùÏÑ±
    function buildTree(data) {
        const tree = document.getElementById("orgTree");
        tree.innerHTML = "";

        const deptMap = {}, companyMap = {};

        // Î∂ÄÏÑú, ÌöåÏÇ¨ Ï†ïÎ≥¥ Ï†ïÎ¶¨
        data.forEach(item => {
            if (!companyMap[item.suberNo]) {
                companyMap[item.suberNo] = { companyName: item.companyName, departments: [] };
            }
            companyMap[item.suberNo].departments.push(item);
            deptMap[item.departmentNo] = item;
        });

        // ÌöåÏÇ¨Î≥Ñ Ìä∏Î¶¨ Íµ¨ÏÑ±
        Object.values(companyMap).forEach(company => {
            const companyLi = document.createElement("li");
            companyLi.innerHTML = `<span class="toggle-icon">‚ñ∂</span> <strong style="color:blue">${company.companyName}</strong>`;
            const deptTree = document.createElement("ul");
            deptTree.style.display = "none";

            const topDepts = company.departments.filter(d => !company.departments.some(sub => sub.departmentNo === d.upperDepNo));
            topDepts.forEach(dept => deptTree.appendChild(createDeptNode(dept, deptMap)));

            companyLi.appendChild(deptTree);
            tree.appendChild(companyLi);

            // ÌéºÏπòÍ∏∞ Î≤ÑÌäº
            companyLi.querySelector(".toggle-icon").addEventListener("click", function () {
                deptTree.style.display = deptTree.style.display === "none" ? "block" : "none";
                this.textContent = deptTree.style.display === "none" ? "‚ñ∂" : "‚ñº";
            });
        });
    }

    // Î∂ÄÏÑú ÎÖ∏Îìú ÏÉùÏÑ±
    function createDeptNode(dept, deptMap) {
        const li = document.createElement("li");
        const subTree = document.createElement("ul");
        subTree.style.display = "none";

        const empList = (dept.employees || []).map(emp => `
            <li>
                üôç‚Äç‚ôÇÔ∏è <a href="#" onclick="
                    showEmpInfo('${emp.employeeName}', '${dept.departmentName}', '${emp.jobTitleName}', '${emp.phoneNumber}');
                    selectManager(${emp.employeeNo});
                ">${emp.employeeName} (${emp.jobTitleName})</a>
            </li>`).join('');

        li.innerHTML = `<span class="toggle-icon">‚ñ∂</span> üìÅ <strong>${dept.departmentName}</strong><ul>${empList}</ul>`;

        // ÌïòÏúÑ Î∂ÄÏÑú Ïó∞Í≤∞
        (Object.values(deptMap).filter(d => d.upperDepNo === dept.departmentNo) || [])
            .forEach(sub => subTree.appendChild(createDeptNode(sub, deptMap)));

        li.querySelector("ul").appendChild(subTree);

        // Ìä∏Î¶¨ ÌéºÏπòÍ∏∞ Ïù¥Î≤§Ìä∏
        li.querySelector(".toggle-icon").addEventListener("click", function () {
            subTree.style.display = subTree.style.display === "none" ? "block" : "none";
            this.textContent = subTree.style.display === "none" ? "‚ñ∂" : "‚ñº";
        });

        return li;
    }

    // Ïò§Î•∏Ï™Ω Ï†ïÎ≥¥ Ïπ¥ÎìúÏóê ÏÑ†ÌÉùÌïú ÏÇ¨Ïõê ÌëúÏãú
    function showEmpInfo(name, dept, title, phone) {
        document.getElementById("empName").textContent = name;
        document.getElementById("empDept").textContent = dept;
        document.getElementById("empTitle").textContent = title;
        document.getElementById("empPhone").textContent = phone;
    }

    // Î∂ÄÏÑúÏû• ÏßÄÏ†ï
    function selectManager(employeeNo) {
        if (!selectedDeptNo) return;
        if (!confirm("Ïù¥ ÏÇ¨ÏõêÏùÑ Î∂ÄÏÑúÏû•ÏúºÎ°ú ÏßÄÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;

        const params = new URLSearchParams();
        params.append("employeeNo", employeeNo);
        params.append("departmentNo", selectedDeptNo);

        fetch("/updateManager", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [csrfHeader]: csrfToken
            },
            body: params
        })
        .then(res => res.text())
        .then(result => {
            if (result === "success") {
                alert("Î∂ÄÏÑúÏû•Ïù¥ ÏßÄÏ†ïÎêòÏóàÏäµÎãàÎã§.");
                location.reload();
            } else {
                alert("ÏßÄÏ†ï Ïã§Ìå®!");
            }
        })
        .catch(err => {
            alert("Ïò§Î•ò Î∞úÏÉù!");
            console.error(err);
        });
    }

    // Ï°∞ÏßÅÎèÑ Í≤ÄÏÉâ Í∏∞Îä•
    document.getElementById("searchInput").addEventListener("input", function () {
        const searchText = this.value.toLowerCase();
        const items = document.querySelectorAll("#orgTree li");
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchText)) {
                item.style.display = "";
                let parent = item.parentElement;
                while (parent && parent.id !== "orgTree") {
                    if (parent.tagName === "UL") parent.style.display = "block";
                    if (parent.tagName === "LI") {
                        const toggle = parent.querySelector(".toggle-icon");
                        if (toggle) toggle.textContent = "‚ñº";
                    }
                    parent = parent.parentElement;
                }
            } else {
                item.style.display = "none";
            }
        });
    });
    
 // Î∂ÄÏÑú ÏÇ≠Ï†ú ÏöîÏ≤≠
    function deleteDepartment(departmentNo) {
        if (!confirm("Ï†ïÎßêÎ°ú Ïù¥ Î∂ÄÏÑúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;

        fetch("/deleteDepartment", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [csrfHeader]: csrfToken
            },
            body: "departmentNo=" + departmentNo
        })
        .then(res => res.text())
        .then(result => {
            if (result === "hasChild") {
                alert("‚ùå ÌïòÏúÑ Î∂ÄÏÑúÍ∞Ä ÏûàÏñ¥ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
            } else if (result === "hasEmployee") {
                alert("‚ùå ÏÜåÏÜçÎêú ÏÇ¨ÏõêÏù¥ ÏûàÏñ¥ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
            } else if (result === "success") {
                alert("‚úÖ Î∂ÄÏÑúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                location.reload();
            } else {
                alert("‚ö†Ô∏è ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            }
        })
        .catch(err => {
            alert("üö® Ïò§Î•ò Î∞úÏÉù");
            console.error(err);
        });
    }

</script>

</body>
</html>
