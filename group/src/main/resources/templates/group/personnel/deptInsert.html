<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default_layout}"
      layout:fragment="content">

<head>
    <meta charset="UTF-8">
    <title>ë¶€ì„œ ê´€ë¦¬</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.6.2/css/bootstrap.min.css">
</head>

<body>
<div class="container mt-4">
    <h2 class="text-center mb-4">ë¶€ì„œ ê´€ë¦¬</h2>
    <div class="row">

        <!-- ì™¼ìª½: ë¶€ì„œ ë“±ë¡ ì˜ì—­ -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header font-weight-bold text-center">ë¶€ì„œ ë“±ë¡</div>
                <div class="card-body">
                    <form th:action="@{/deptInsert}" th:object="${deptVO}" method="post" onsubmit="return confirmInsert()">
                        <input type="hidden" th:field="*{departmentNo}"/>
                        <input type="hidden" th:field="*{suberNo}"/>

                        <div class="form-group">
                            <label>ë¶€ì„œëª…</label>
                            <input type="text" class="form-control" th:field="*{departmentName}" required>
                        </div>

                        <div class="form-group">
                            <label>ìƒìœ„ ë¶€ì„œ</label>
                            <select class="form-control" th:field="*{upperDepNo}">
                                <option value="0">ìµœìƒìœ„ ë¶€ì„œ</option>
                                <option th:each="dept : ${deptList}"
                                        th:value="${dept.departmentNo}"
                                        th:text="${dept.departmentName}">
                                </option>
                            </select>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-block">ë“±ë¡</button>
                            <button type="button" class="btn btn-danger btn-block" onclick="window.history.back()">ë’¤ë¡œ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ë¶€ì„œì¥ ì§€ì • ë¦¬ìŠ¤íŠ¸ (í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ) -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header font-weight-bold text-center">ë¶€ì„œì¥ ì¶”ê°€</div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            th:each="dept : ${deptList}"
                            th:onclick="|openOrgModal(${dept.departmentNo})|" style="cursor:pointer">
                            <strong th:text="${dept.departmentName}"></strong>
                            <span th:if="${dept.employeeName != null}"
                                  th:text="' - ë¶€ì„œì¥: ' + ${dept.employeeName}"
                                  class="text-success ml-2"></span>
                            <span th:if="${dept.employeeName == null}" class="text-danger ml-2">(ë¶€ì„œì¥ ë¯¸ì§€ì •)</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ì¡°ì§ë„ ëª¨ë‹¬ -->
<div class="modal fade" id="orgModal" tabindex="-1" role="dialog" aria-labelledby="orgModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì¡°ì§ë„ì—ì„œ ë¶€ì„œì¥ ì„ íƒ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- ì¡°ì§ë„ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë¹„ë™ê¸°ë¡œ ë¡œë“œë¨ -->
                <div id="orgTreeContainer"></div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // ë“±ë¡ ì™„ë£Œ ì•Œë¦¼
    function confirmInsert() {
        alert("ë¶€ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        return true;
    }

 // ì¡°ì§ë„ ë¶ˆëŸ¬ì˜¤ê¸°
    function buildTree(data, treeId) {
        const tree = document.getElementById(treeId);
        tree.innerHTML = "";

        const deptMap = {}, childDeptMap = {};
        data.forEach(dept => {
            if (!deptMap[dept.departmentNo]) deptMap[dept.departmentNo] = dept;
            if (!childDeptMap[dept.upperDepNo]) childDeptMap[dept.upperDepNo] = [];
            childDeptMap[dept.upperDepNo].push(dept);
        });

        const topDepts = childDeptMap[null] || childDeptMap[0] || [];
        topDepts.forEach(dept => {
            const deptLi = createDeptNodeRecursive(dept, childDeptMap);
            tree.appendChild(deptLi);
        });
    }

    function createDeptNodeRecursive(dept, childDeptMap) {
        const deptLi = document.createElement("li");
        deptLi.innerHTML = `<span class="toggle-icon">â–¶</span> ğŸ“ <strong>${dept.departmentName} (${dept.employees.length}ëª…)</strong>`;
        const subTree = document.createElement("ul");
        subTree.style.display = "none";

        dept.employees.forEach(emp => {
            const empLi = document.createElement("li");
            empLi.innerHTML = `
              <input type="checkbox" class="emp-check" value="${emp.employeeNo}" data-name="${emp.employeeName}" data-job="${emp.jobTitleName}">
              ğŸ™â€â™‚ï¸ ${emp.employeeName} (${emp.jobTitleName})
            `;
            subTree.appendChild(empLi);
        });

        const children = childDeptMap[dept.departmentNo] || [];
        children.forEach(child => {
            const subDeptLi = createDeptNodeRecursive(child, childDeptMap);
            subTree.appendChild(subDeptLi);
        });

        deptLi.querySelector(".toggle-icon").addEventListener("click", function () {
            subTree.style.display = subTree.style.display === "none" ? "block" : "none";
            this.textContent = subTree.style.display === "none" ? "â–¶" : "â–¼";
        });

        deptLi.appendChild(subTree);
        return deptLi;
    }

    function filterTree(inputId, treeId) {
        const searchText = document.getElementById(inputId).value.toLowerCase();
        document.querySelectorAll(`#${treeId} li`).forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchText) ? "" : "none";
        });
    }

    // ì„ íƒí•œ ì‚¬ì›ì„ ë¶€ì„œì¥ìœ¼ë¡œ ì§€ì •
    function selectManager(employeeNo, departmentNo) {
        if (confirm('ì´ ì‚¬ì›ì„ ë¶€ì„œì¥ìœ¼ë¡œ ì§€ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            fetch(`/updateManager?employeeNo=${employeeNo}&departmentNo=${departmentNo}`, { method: 'POST' })
                .then(() => location.reload());
        }
    }
</script>

<!-- Bootstrap JS (ëª¨ë‹¬ìš©) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
