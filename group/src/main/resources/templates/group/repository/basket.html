<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>íœ´ì§€í†µ</title>
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
	rel="stylesheet">
</head>
<body>

	<!-- âœ… ë“œë¡­ë‹¤ìš´ form (form ì¤‘ì²© ë°©ì§€ìš©, ì¹´ë“œ ë°”ê¹¥) -->
	<form id="filterForm" method="get" action="/basket"
		class="mb-3 d-flex justify-content-end align-items-center">
		<select id="repositoryType" name="repositoryType"
			class="form-control form-control-sm"
			onchange="document.getElementById('filterForm').submit();"
			style="width: 200px;">
			<option value="ì „ì²´" th:selected="${repositoryType == 'ì „ì²´'}">ì „ì²´</option>
			<option value="ë¶€ì„œ" th:selected="${repositoryType == 'ë¶€ì„œ'}">ë¶€ì„œ</option>
			<option value="ê°œì¸" th:selected="${repositoryType == 'ê°œì¸'}">ê°œì¸</option>
		</select> <input type="hidden" name="keyword" th:value="${keyword}" />
	</form>

	<form id="basketForm" method="post">
		<input type="hidden" name="repositoryType"
			th:value="${repositoryType}" />

		<div class="card shadow mb-4" style="width: 100%;">
			<div class="card-header py-3">
				<h6 class="m-0 font-weight-bold text-primary">íœ´ì§€í†µ</h6>
			</div>

			<div class="card-body">
				<!-- ğŸ” ê²€ìƒ‰ì°½ -->
				<div class="position-relative mb-3" style="width: 350px; margin: 0 auto;">
  					<input type="text" id="searchInput" name="keyword" class="form-control pl-4"
         					placeholder="   ê²€ìƒ‰ì–´ ì…ë ¥" th:value="${keyword}" />
  						<button type="button" onclick="submitSearchForm()" 
          						style="position: absolute; top: 50%; left: 3px; transform: translateY(-50%); background: none; border: none;">
    						<i class="fas fa-search" style="color: #aaa;"></i>
  						</button>
				</div>
				<br>
				<!-- ğŸ“„ í…Œì´ë¸” -->
				<div class="table-responsive">
					<table class="table table-bordered" id="dataTable" width="100%"
						cellspacing="0">
						<thead>
							<tr>
								<th><input type="checkbox" id="selectAll"></th>
								<th>ì œëª©</th>
								<th>ì‘ì„±ì</th>
								<th>íŒŒì¼ëª…</th>
								<th>ì‘ì„±ì¼</th>
								<th>ì‚­ì œì¼</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="post : ${basketList}"
								th:onclick="'goToBasketDetail(' + ${post.writingId} + ')'"
								style="cursor: pointer;">
								<td><input type="checkbox" name="writingIds"
									th:value="${post.writingId}" class="file-checkbox"
									onclick="event.stopPropagation();"></td>
								<td th:text="${post.title}"></td>
								<td th:text="${post.writer}"></td>
								<td
									th:text="${post.fileCount > 1 ? post.fileName + ' ì™¸ ' + (post.fileCount - 1) + 'ê±´' : post.fileName}"></td>
								<td th:text="${#dates.format(post.creationDate, 'yyyy-MM-dd')}"></td>
								<td th:text="${#dates.format(post.delDate, 'yyyy-MM-dd')}"></td>
							</tr>
							<tr th:if="${#lists.isEmpty(basketList)}">
								<td colspan="6" class="text-center text-muted">íœ´ì§€ëœ ìë£Œê°€
									ì—†ìŠµë‹ˆë‹¤.</td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- âœ… ë³µì›/ì‚­ì œ ë²„íŠ¼ -->
				<div class="d-flex justify-content-end mt-3 mb-2">
					<button type="submit" class="btn btn-success mr-2"
						formaction="/basket/restore">ë³µì›</button>
					<button type="submit" class="btn btn-danger"
						formaction="/basket/delete">ì‚­ì œ</button>
				</div>

				<!-- âœ… í˜ì´ì§€ë„¤ì´ì…˜ -->
				<div class="d-flex justify-content-center">
					<nav aria-label="í˜ì´ì§€ë„¤ì´ì…˜">
						<ul class="pagination mb-0">
							<li class="page-item" th:classappend="${page == 1} ? 'disabled'">
								<a class="page-link"
								th:href="@{/basket(repositoryType=${repositoryType}, page=${page - 1}, keyword=${keyword})}">&laquo;</a>
							</li>
							<li class="page-item"
								th:each="i : ${#numbers.sequence(1, totalPages > 0 ? totalPages : 1)}"
								th:classappend="${i == page} ? 'active'"><a
								class="page-link"
								th:href="@{/basket(repositoryType=${repositoryType}, page=${i}, keyword=${keyword})}"
								th:text="${i}"></a></li>
							<li class="page-item"
								th:classappend="${page == totalPages} ? 'disabled'"><a
								class="page-link"
								th:href="@{/basket(repositoryType=${repositoryType}, page=${page + 1}, keyword=${keyword})}">&raquo;</a>
							</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
	</form>

<script>
  document.getElementById('selectAll').addEventListener('change', function () {
    const checkboxes = document.querySelectorAll('.file-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
  });

//ë³µì› ë²„íŠ¼ë§Œ ê°ì§€
  document.querySelector('button[formaction="/basket/restore"]').addEventListener('click', function (e) {
    const checked = document.querySelectorAll('.file-checkbox:checked');
    if (checked.length === 0) {
      alert("ë³µì›í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      e.preventDefault();
    }
  });

  // ì‚­ì œ ë²„íŠ¼ë§Œ ê°ì§€
  document.querySelector('button[formaction="/basket/delete"]').addEventListener('click', function (e) {
    const checked = document.querySelectorAll('.file-checkbox:checked');
    if (checked.length === 0) {
      alert("ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      e.preventDefault();
    }
  });

  function goToBasketDetail(writingId) {
    window.location.href = '/detailBasket/' + writingId;
  }

  document.querySelectorAll('.file-checkbox').forEach(cb => {
    cb.addEventListener('click', function (event) {
      event.stopPropagation();
    });
  });
</script>
<script>
  function submitSearchForm() {
    const keyword = document.getElementById("searchInput").value;
    const type = document.querySelector('select[name="repositoryType"]')?.value || "ì „ì²´";
    const url = `/basket?repositoryType=${encodeURIComponent(type)}&keyword=${encodeURIComponent(keyword)}`;
    window.location.href = url;
  }

  // Enter í‚¤ ëˆŒëŸ¬ë„ ê²€ìƒ‰ë˜ê²Œ
  document.getElementById("searchInput").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      submitSearchForm();
    }
  });
</script>
</body>
</html>
