<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="content">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Context Path ì¶”ê°€
    <meta name="contextPath" value="/myapp">-->

<title>ë‚´ì •ë³´ ìˆ˜ì •</title>
<style>
/* ë©”ì¸ ì»¨í…Œì´ë„ˆ*/
.content-wrapper {
	display: flex;
	justify-content: center;
	align-items: center;
	height: calc(100vh - 100px);
	width: 100%;
	padding: 20px;
	box-sizing: border-box;
}

/* ì‚¬ì› ìƒì„¸ì •ë³´ ë°•ìŠ¤ í¬ê¸° ì¡°ì • */
.employee-container {
	width: 700px;
	background: white;
	padding: 15px;
	border-radius: 10px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
	text-align: center;
}

.emph2 {
	margin-bottom: 15px;
	font-size: 18px;
}

.profile-img {
	width: 100px;
	height: 100px;
	object-fit: cover; /* ì›ë³¸ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ ë°•ìŠ¤ í¬ê¸°ì— ë§ì¶¤ */
	border: 1px solid #ddd; /* í…Œë‘ë¦¬ ì¶”ê°€ */
	display: block;
	margin: 0 auto;
}

.profile-img img {
	width: 100px;
	height: 100px;
	object-fit: cover; /* ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ í¬ê¸°ì— ë§ê²Œ ìë¦„ */
	display: block;
	margin: 0 auto;
}

.form-container {
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	gap: 10px;
}

.form-group {
	flex: 1 1 calc(50% - 10px);
	min-width: 250px;
	text-align: left;
}

.form-group label {
	font-weight: bold;
	display: block;
	margin-bottom: 5px;
	font-size: 14px;
}

.form-group input, .form-group select {
	width: 100%;
	padding: 6px;
	border: 1px solid #ccc;
	border-radius: 5px;
	background-color: #f8f9fa;
	font-size: 14px;
}

.btn-group {
	display: flex;
	justify-content: space-between;
	margin-top: 15px;
}

.btn {
	padding: 8px 12px;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	font-size: 14px;
	width: 48%;
}

.btn-update {
	background: #007bff;
	color: white;
}

.btn-cancel {
	background: #dc3545;
	color: white;
}
</style>
</head>
<body>

	<form name="updateForm" th:action="@{/MyPageUpdate}" th:object="${emp}"
		method="post" enctype="multipart/form-data">

		<div class="content-wrapper">
			<div class="employee-container">
				<h2 class="emph2">ë‚´ì •ë³´ ìˆ˜ì •</h2>

				<!-- í”„ë¡œí•„ ì´ë¯¸ì§€ -->
				<div class="profile-container">
					<img id="imagePreview" class="profile-img"
						th:src="'data:image/png;base64,' + ${profileImageBase64}"
						alt="í”„ë¡œí•„ ì´ë¯¸ì§€" onclick="document.getElementById('photo').click();">
					<input type="file" id="photo" name="profileImageFile"
						accept="image/*" style="display: none;"
						onchange="previewImage(event)">
				</div>

				<div class="form-container">
					<!-- ì‚¬ì› ID (readonly) -->
					<div class="form-group">
						<label>ID</label> <input type="text" th:value="${emp.employeeId}"
							readonly>
					</div>

					<!-- ë¹„ë°€ë²ˆí˜¸ -->
					<div class="form-group">
						<label>ë¹„ë°€ë²ˆí˜¸</label> <input type="password"
							th:field="*{employeePw}">
						<button type="button" onclick="resetPassword()">ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</button>
					</div>

					<!-- ì‚¬ì› ë²ˆí˜¸ (readonly) -->
					<div class="form-group">
						<label>ì‚¬ì›ë²ˆí˜¸</label> <input type="hidden" name="employeeNo"
							th:value="${emp.employeeNo}" readonly>
					</div>

					<!-- ì´ë¦„ (readonly) -->
					<div class="form-group">
						<label>ì´ë¦„</label> <input type="text" name="employeeName"
							th:value="${emp.employeeName}" readonly required>
					</div>

					<!-- ë¶€ì„œëª… (readonly) -->
					<div class="form-group">
						<label>ë¶€ì„œ</label> <input type="text"
							th:value="${emp.departmentName}" readonly>
					</div>

					<!-- ì§ê¸‰ (readonly) -->
					<div class="form-group">
						<label>ì§ê¸‰</label> <input type="text"
							th:value="${emp.jobTitleName}" readonly> <input
							type="hidden" name="rankId" th:value="${emp.rankId}">
						<!-- âœ… ì„œë²„ ì „ì†¡ìš© -->
					</div>

					<!-- ê¶Œí•œ (readonly) -->
					<div class="form-group">
						<label>ê¶Œí•œ</label> <input type="text" th:value="${emp.rightsName}"
							readonly> <input type="hidden" name="rightsId"
							th:value="${emp.rightsId}">
					</div>

					<!-- ì—°ë½ì²˜ -->
					<div class="form-group">
						<label>ì—°ë½ì²˜</label> <input type="text" th:field="*{phoneNumber}">
					</div>

					<!-- ì£¼ì†Œ (readonly, ìƒì„¸ì£¼ì†ŒëŠ” ë³„ë„ ì…ë ¥) -->
					<div class="form-group">
						<label>ì£¼ì†Œ</label> <input type="text" id="address"
							th:field="*{address}" readonly>
						<button type="button" onclick="searchAddress()">ì£¼ì†Œ ê²€ìƒ‰</button>
					</div>

					<!-- ìƒì„¸ì£¼ì†Œ -->
					<div class="form-group">
						<label>ìƒì„¸ì£¼ì†Œ</label> <input type="text" id="detailAddress"
							placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥">
					</div>

					<!-- ì…ì‚¬ì¼ (readonly) -->
					<div class="form-group">
						<label>ì…ì‚¬ì¼</label> <input type="text"
							th:value="${#dates.format(emp.hireDate, 'yyyy-MM-dd')}" readonly>
					</div>

					<!-- ì„ì‹œ IP -->
					<div class="form-group">
						<label>ì ‘ì† IP</label> <input type="text" th:field="*{tempIp}">
					</div>
				</div>

				<!-- ë²„íŠ¼ -->
				<div class="btn-group">
					<button type="submit" class="btn btn-update">ìˆ˜ì •</button>
					<button type="button" class="btn btn-cancel"
						th:onclick="|location.href='@{/MyPageInfo}'|">ì·¨ì†Œ</button>
				</div>
			</div>
		</div>
	</form>



	<!--  ì¹´ì¹´ì˜¤ ì£¼ì†Œ API -->
	<script
		src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=843f623b54841d7e48c15c0667f81957&libraries=services"></script>
	<script
		src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

	<script>
	// ğŸ“Œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
	function previewImage(event) {
		const file = event.target.files[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = (e) => {
				document.getElementById('imagePreview').src = e.target.result;
			};
			reader.readAsDataURL(file);
		}
	}

	// ğŸ” ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
	function resetPassword() {
		const employeeNo = document.getElementById("employeeNo").value;

		fetch(`/api/resetPassword?employeeNo=${employeeNo}`, {
			method: "POST"
		})
			.then(res => res.text())
			.then(msg => alert(msg))
			.catch(err => console.error("ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì‹¤íŒ¨:", err));
	}

	// ğŸ“¤ FormData ë°©ì‹ AJAX ì „ì†¡
	document.forms.updateForm.addEventListener("submit", function (event) {
		event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë§‰ê¸°

		// ğŸ“¦ ì£¼ì†Œ ë³‘í•©
		const addressField = document.getElementById("address");
		const detailField = document.getElementById("detailAddress");
		if (addressField && detailField) {
			addressField.value = addressField.value + " " + detailField.value;
		}

		// ğŸ“¤ FormData ìƒì„± (íŒŒì¼ í¬í•¨)
		const formData = new FormData(this);
		
		const employeeNoInput = document.getElementById("employeeNo");
		if (employeeNoInput) {
			formData.append("employeeNo", employeeNoInput.value);
		}
		fetch("/MyPageUpdate", {
			method: "POST",
			body: formData // âœ… í—¤ë” ìƒëµ, ìë™ ì„¤ì •ë¨
		})
			.then(response => {
				if (response.redirected) {
					window.location.href = response.url;
				} else {
					return response.text();
				}
			})
			.then(data => {
				if (typeof data === "string" && data.includes("ì—ëŸ¬")) {
					alert("ì˜¤ë¥˜ ë°œìƒ: " + data);
				}
			})
			.catch(error => {
				console.error("ìˆ˜ì • ì‹¤íŒ¨:", error);
				alert("ì •ë³´ ìˆ˜ì • ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			});
	});

	// ğŸ  ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰
	function searchAddress() {
		new daum.Postcode({
			oncomplete: function (data) {
				const fullAddress = `[${data.zonecode}] ${data.roadAddress}`;
				document.getElementById("address").value = fullAddress;
			}
		}).open();
	}

	// ğŸ”§ ìƒì„¸ì£¼ì†Œ ë¶„ë¦¬
	function splitAddressOnLoad() {
		const addressField = document.getElementById("address");
		const detailField = document.getElementById("detailAddress");

		if (addressField && detailField && addressField.value.includes("]")) {
			const parts = addressField.value.split("] ");
			addressField.value = parts[0] + "]";
			detailField.value = parts[1] || "";
		}
	}

	// ğŸ“¥ ì…€ë ‰íŠ¸ë°•ìŠ¤ ë°ì´í„° ë¹„ë™ê¸° ë¡œë“œ
	function loadSelectData(url, selectId, valueField, textField, selectedValue = null) {
		fetch(url)
			.then(res => res.json())
			.then(data => {
				const select = document.getElementById(selectId);
				if (!select) return;
				select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

				data.forEach(item => {
					const option = document.createElement("option");
					option.value = item[valueField];
					option.textContent = item[textField];
					if (selectedValue && selectedValue == item[valueField]) {
						option.selected = true;
					}
					select.appendChild(option);
				});
			})
			.catch(error => {
				console.error(`Error loading select box '${selectId}':`, error);
			});
	}

	// ğŸ“¦ í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ì‹¤í–‰
	document.addEventListener("DOMContentLoaded", function () {
		const selectedDepartment = "[[${emp.departmentNo}]]";
		const selectedRank = "[[${emp.rankId}]]";
		const selectedRight = "[[${emp.rightsId}]]";

		loadSelectData("/api/departments", "department", "departmentNo", "departmentName", selectedDepartment);
		loadSelectData("/api/ranks", "position", "rankId", "jobTitleName", selectedRank);
		loadSelectData("/api/rights", "role", "rightsId", "rightsName", selectedRight);

		splitAddressOnLoad();
	});
</script>


</body>
</html>
