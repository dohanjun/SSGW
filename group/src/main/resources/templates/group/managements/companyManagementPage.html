<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}"
	layout:fragment="content">
<head>
<meta charset="UTF-8">
<title>íšŒì‚¬ ì •ë³´</title>
<style>
.company-container {
	max-width: 800px;
	margin: 40px auto;
	padding: 40px;
	background-color: #eee;
	border-radius: 10px;
}

.company-container h2 {
	text-align: center;
	margin-bottom: 40px;
}

.row {
	display: flex;
	gap: 20px;
	margin-bottom: 20px;
}

.form-group {
	flex: 1;
	display: flex;
	flex-direction: column;
}

label {
	font-weight: bold;
	margin-bottom: 5px;
}

input, select {
	padding: 10px;
	font-size: 14px;
	border: 1px solid #ccc;
	border-radius: 6px;
	background-color: #fff;
}

.button-row {
	display: flex;
	justify-content: space-between;
	margin-top: 30px;
}

.btn {
	padding: 12px 24px;
	border: none;
	border-radius: 8px;
	font-size: 16px;
	font-weight: bold;
	cursor: pointer;
}

.btn-save {
	background-color: #2ecc71;
	color: white;
}

.btn-manage {
	background-color: #3498db;
	color: white;
}
</style>
</head>
<body>
	<div class="company-container">
		<h2>íšŒì‚¬ ì •ë³´ ìˆ˜ì •</h2>

		<form method="post" th:action="@{/updateCompanyInfo}">
			<input type="hidden" name="suberNo" th:value="${suber.suberNo}" />

			<div class="row">
				<div class="form-group">
					<label>íšŒì‚¬ ì´ë¦„</label> <input type="text" name="companyName"
						th:value="${suber.companyName}">
				</div>
				<div class="form-group">
					<label>ì´ë¦„</label> <input type="text" name="subName"
						th:value="${suber.subName}">
				</div>
			</div>
			<div class="row">

				<div class="form-group">
					<label>ì•„ì´ë””</label> <input type="text" name="subId"
						th:value="${suber.subId}" readonly>
				</div>
				<div class="form-group">
					<label>ë¹„ë°€ë²ˆí˜¸</label> <input type="password" name="subPw"
						th:value="${suber.subPw}">
				</div>
				<div class="form-group">
					<label>UID</label> <input type="text" name="subUid"
						th:value="${suber.subUid}" readonly>
				</div>
			</div>

			<div class="row">
				<div class="form-group">
					<label>ì´ë©”ì¼</label> <input type="text" name="subEmail"
						th:value="${suber.subEmail}">
				</div>
				<div class="form-group">
					<label>ì‚¬ì—…ì ë²ˆí˜¸</label> <input type="text" name="subBnisNo"
						th:value="${suber.subBnisNo}">
				</div>
				<div class="form-group">
					<label>ë„ë©”ì¸</label> <input type="text" name="domain"
						th:value="${suber.domain}" readonly>
				</div>
			</div>

			<div class="row">
				<div class="form-group">
					<label>íšŒì‚¬ IP</label> <input type="text" name="firstIp"
						th:value="${suber.firstIp}">
				</div>
				<div class="form-group">
					<label>ì„œë¸Œ IP</label> <input type="text" name="secondIp"
						th:value="${suber.secondIp}">
				</div>
			</div>

			<div class="row">
				<div class="form-group">
					<label>ìµœëŒ€ ì¸ì›</label> <select name="maxCount">
						<option th:each="i : ${#numbers.sequence(10, 100, 10)}"
							th:value="${i}" th:text="${i + 'ëª…'}"
							th:selected="${i == suber.maxCount}"></option>
					</select>
				</div>
				<div class="form-group">
					<label>ìµœëŒ€ ì—…ë¡œë“œ ìš©ëŸ‰</label> <select name="maxUpSize">
						<option th:value="10" th:selected="${suber.maxUpSize == 10}">10
							MB</option>
						<option th:value="25" th:selected="${suber.maxUpSize == 25}">25
							MB</option>
						<option th:value="50" th:selected="${suber.maxUpSize == 50}">50
							MB</option>
						<option th:value="100" th:selected="${suber.maxUpSize == 100}">100
							MB</option>
					</select>
				</div>
				<div class="form-group">
					<label>ìµœëŒ€ ì €ì¥ ìš©ëŸ‰</label> <select name="maxSize">
						<option th:each="i : ${#numbers.sequence(1, 5)}" th:value="${i}"
							th:text="${i + ' GB'}" th:selected="${i == suber.maxSize}">
						</option>
					</select>
				</div>
			</div>
			<div class="button-row">
				<button type="submit" class="btn btn-save">ì €ì¥</button>
				<button type="button" class="btn btn-manage"
					th:onclick="|location.href='@{/suberModuleInfo(suberNo=${suber.suberNo})}'|">
					ëª¨ë“ˆ ê´€ë¦¬</button>
			</div>
		</form>
	</div>
	<div id="payModal" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%, -30%); background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.3);">
  <p style="font-weight:bold;">ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
  <button onclick="selectPay('card')">ğŸ’³ ì¹´ë“œê²°ì œ</button>
  <button onclick="selectPay('bank')">ğŸ¦ ê³„ì¢Œì´ì²´</button>
  <button onclick="closePayModal()">âŒ ì·¨ì†Œ</button>
</div>

	
</body>
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script th:inline="javascript">
	var suber = /*[[${suber}]]*/[];
	const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	document.addEventListener("DOMContentLoaded", function () {
		  const current = {
		    maxSize: Number(suber.maxSize),
		    maxCount: Number(suber.maxCount),
		    maxUpSize: Number(suber.maxUpSize)
		  };

		  $("select[name='maxSize'] option").each(function () {
		    if (Number($(this).val()) < current.maxSize) {
		      $(this).prop("disabled", true);
		    }
		  });

		  $("select[name='maxCount'] option").each(function () {
		    if (Number($(this).val()) < current.maxCount) {
		      $(this).prop("disabled", true);
		    }
		  });

		  $("select[name='maxUpSize'] option").each(function () {
		    if (Number($(this).val()) < current.maxUpSize) {
		      $(this).prop("disabled", true);
		    }
		  });
		});

	$('.btn-save').on('click',e=>{
		e.preventDefault();
		const current = {
				  maxSize: Number(suber.maxSize),
				  maxCount: Number(suber.maxCount),
				  maxUpSize: Number(suber.maxUpSize)
				};

				const selected = {
				  maxSize: Number($('select[name="maxSize"]').val()),
				  maxCount: Number($('select[name="maxCount"]').val()),
				  maxUpSize: Number($('select[name="maxUpSize"]').val())
				};

				// ë‹¨ê°€
				const unitPrice = {
				  maxCount: 100000 / 10,
				  maxUpSize: 10000 / 5,
				  maxSize: 100000 
				};

				let totalDiff = 0;
				let details = [];
				for (let key in current) {
					  const diff = selected[key] - current[key];
					  if (diff > 0) {
					    const price = diff * unitPrice[key];
					    totalDiff += price;
					    details.push(`${key}: +${price.toLocaleString()}ì›`);
					  }
					}

				if (totalDiff > 0) {
					  if (confirm(`ğŸ’³ ${totalDiff.toLocaleString()}ì›ì´ ê²°ì œë©ë‹ˆë‹¤. ê²°ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
						  let phoneNumber = prompt("ê²°ì œë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì „í™”ë²ˆí˜¸ë‚˜ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
						  if (phoneNumber !== null) {
						      if (confirm("ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”.\ní™•ì¸ì„ ëˆ„ë¥´ë©´ ì¹´ë“œê²°ì œ, ì·¨ì†ŒëŠ” ê³„ì¢Œì´ì²´ì…ë‹ˆë‹¤.")) {
						    	  payment("card",phoneNumber,totalDiff);
						      } else {
						    	  payment();
						      }
						  } else {
						      alert("ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
						  }
						  
					  } else {
					    console.log("ê²°ì œ ì·¨ì†Œ");
					  }
					} else {
					  saveSuber();
					}


	})

	
function payment(type,phonenumber,totalDiff) {
	var merchant_uid = "order" + new Date().getTime();
	var username = suber.subName;
	var userEmail = suber.subEmail;
	var userPhone = phonenumber;
	let num = totalDiff;
	
	IMP.init('imp07168373');

	IMP.request_pay(
		{
			pg: "html5_inicis",
			pay_method: type,
			merchant_uid: merchant_uid,
			name: username + "ë‹˜ì˜ ê²°ì œ",
			amount: 100,
			buyer_email: userEmail,
			buyer_name: username,
			buyer_tel: userPhone,
			escrow: true,
			vbank_due: "YYYYMMDD",
		},
		function(rsp) {
			if (rsp.success) {
				$.ajax({
					type: "POST",
					url: "/savePayment",
					data: JSON.stringify({
						paymentType: type,
						paymentPrice: num,
						suberNo: suber.suberNo,
						paymentStatus: "ì™„ë£Œ",
						claim: "Y",
						claimState: "ì™„ë£Œ"
					}),
		            beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
					contentType: "application/json",
					success: function(response2) {
						updateSuber()
					},
					error: function(xhr, status, error) {
						alert("âŒ ê²°ì œ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
					}
				});

			} else {
				var mesg = 'ê²°ì œë¥¼ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.';
				alert(mesg + rsp.error_msg);
			}
		}
	);
}

	
	
function updateSuber() {
		$.ajax({
			type: "POST",
			url: "/updateSuber",
			data: JSON.stringify({
				suberNo: suber.suberNo,
				subPw: $("input[name='subPw']").val(),
				subName: $("input[name='subName']").val(),
				subEmail: $("input[name='subEmail']").val(),
				subBnisNo: $("input[name='subBnisNo']").val(),
				companyName: $("input[name='companyName']").val(),
				firstIp: $("input[name='firstIp']").val(),
				secondIp: $("input[name='secondIp']").val(),
				maxCount: Number($("select[name='maxCount']").val()),
				maxSize: Number($("select[name='maxSize']").val()),
				maxUpSize: Number($("select[name='maxUpSize']").val())
			}),
            beforeSend: function(xhr) {
                xhr.setRequestHeader(header, token);
            },
			contentType: "application/json",
			success: function(response) {
				alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
			},
			error: function(xhr, status, error) {
				alert("âŒ êµ¬ë…ì ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.");
				console.error(xhr.responseText);
			}
		});
	}
</script>
</html>
